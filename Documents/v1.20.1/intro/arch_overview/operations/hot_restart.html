<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hot restart &mdash; envoy tag-v1.20.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overload manager" href="overload_manager.html" />
    <link rel="prev" title="Runtime configuration" href="runtime.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html">
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                tag-v1.20.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners/listeners_toc.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http/http.html">HTTP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability.html">Observability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/security.html">Security</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="operations.html">Operations &amp; configuration</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="dynamic_configuration.html">xDS configuration API overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="init.html">Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="draining.html">Draining</a></li>
<li class="toctree-l4"><a class="reference internal" href="runtime.html">Runtime configuration</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Hot restart</a></li>
<li class="toctree-l4"><a class="reference internal" href="overload_manager.html">Overload manager</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../other_features/other_features.html">Other features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced/advanced.html">Advanced</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../life_of_a_request.html">Life of a Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">Getting help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../intro.html">Introduction</a> &raquo;</li>
          <li><a href="../arch_overview.html">Architecture overview</a> &raquo;</li>
          <li><a href="operations.html">Operations &amp; configuration</a> &raquo;</li>
      <li>Hot restart</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/intro/arch_overview/operations/hot_restart.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="hot-restart">
<span id="arch-overview-hot-restart"></span><h1>Hot restart<a class="headerlink" href="#hot-restart" title="Permalink to this headline">¶</a></h1>
<p>Ease of operation is one of the primary goals of Envoy. In addition to robust statistics and a local
administration interface, Envoy has the ability to “hot” or “live” restart itself. This means that
Envoy can fully reload itself (both code and configuration) without dropping existing connections
during the <a class="reference internal" href="draining.html#arch-overview-draining"><span class="std std-ref">drain process</span></a>. The hot restart functionality has the
following general architecture:</p>
<ul class="simple">
<li><p>The two active processes communicate with each other over unix domain sockets using a basic RPC
protocol. All counters are sent from the old process to the new process over the unix domain, and
gauges are transported except those marked with <cite>NeverImport</cite>. After hot restart is finished, the
gauges transported from the old process will be cleanup, but special gauge like
<a class="reference internal" href="../../../configuration/observability/statistics.html#server-statistics"><span class="std std-ref">server.hot_restart_generation statistic</span></a> is retained.</p></li>
<li><p>The new process fully initializes itself (loads the configuration, does an initial service
discovery and health checking phase, etc.) before it asks for copies of the listen sockets from
the old process. The new process starts listening and then tells the old process to start
draining.</p></li>
<li><p>During the draining phase, the old process attempts to gracefully close existing connections. How
this is done depends on the configured filters. The drain time is configurable via the
<a class="reference internal" href="../../../operations/cli.html#cmdoption-drain-time-s"><code class="xref std std-option docutils literal notranslate"><span class="pre">--drain-time-s</span></code></a> option and as more time passes draining becomes more aggressive.</p></li>
<li><p>After drain sequence, the new Envoy process tells the old Envoy process to shut itself down.
This time is configurable via the <a class="reference internal" href="../../../operations/cli.html#cmdoption-parent-shutdown-time-s"><code class="xref std std-option docutils literal notranslate"><span class="pre">--parent-shutdown-time-s</span></code></a> option.</p></li>
<li><p>Envoy’s hot restart support was designed so that it will work correctly even if the new Envoy
process and the old Envoy process are running inside different containers. Communication between
the processes takes place only using unix domain sockets.</p></li>
<li><p>An example restarter/parent process written in Python is included in the source distribution. This
parent process is usable with standard process control utilities such as monit/runit/etc.</p></li>
</ul>
<p>Envoy’s default command line options assume that only a single set of Envoy processes is running on
a given host: an active Envoy server process and, potentially, a draining Envoy server process that
will exit as described above. The <a class="reference internal" href="../../../operations/cli.html#cmdoption-base-id"><code class="xref std std-option docutils literal notranslate"><span class="pre">--base-id</span></code></a> or <a class="reference internal" href="../../../operations/cli.html#cmdoption-use-dynamic-base-id"><code class="xref std std-option docutils literal notranslate"><span class="pre">--use-dynamic-base-id</span></code></a> options
may be used to allow multiple, distinctly configured Envoys to run on the same host and hot restart
independently.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature is not supported on Windows.</p>
</div>
<div class="section" id="socket-handling">
<h2>Socket handling<a class="headerlink" href="#socket-handling" title="Permalink to this headline">¶</a></h2>
<p>By default, Envoy uses <a class="reference internal" href="../../../api-v3/config/listener/v3/listener.proto.html#envoy-v3-api-field-config-listener-v3-listener-enable-reuse-port"><span class="std std-ref">reuse_port</span></a> sockets on Linux for better
performance. This feature workers correctly during hot restart because Envoy passes each socket
to the new process by worker index. Thus, no connections are dropped in the accept queues of
the draining process.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>In the uncommon case in which concurrency changes during hot restart, no connections will be
dropped if concurrency increases. However, if concurrency decreases some connections may be
dropped in the accept queues of the old process workers.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="runtime.html" class="btn btn-neutral float-left" title="Runtime configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="overload_manager.html" class="btn btn-neutral float-right" title="Overload manager" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2021, Envoy Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>