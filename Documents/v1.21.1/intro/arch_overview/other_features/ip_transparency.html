<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IP Transparency &mdash; envoy tag-v1.21.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Compression Libraries" href="compression/libraries.html" />
    <link rel="prev" title="Scripting" href="scripting.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html">
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                tag-v1.21.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners/listeners_toc.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http/http.html">HTTP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability.html">Observability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/security.html">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operations/operations.html">Operations &amp; configuration</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="other_features.html">Other features</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="local_rate_limiting.html">Local rate limiting</a></li>
<li class="toctree-l4"><a class="reference internal" href="global_rate_limiting.html">Global rate limiting</a></li>
<li class="toctree-l4"><a class="reference internal" href="bandwidth_limiting.html">Bandwidth limiting</a></li>
<li class="toctree-l4"><a class="reference internal" href="scripting.html">Scripting</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">IP Transparency</a></li>
<li class="toctree-l4"><a class="reference internal" href="compression/libraries.html">Compression Libraries</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced/advanced.html">Advanced</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../life_of_a_request.html">Life of a Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">Getting help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../intro.html">Introduction</a> &raquo;</li>
          <li><a href="../arch_overview.html">Architecture overview</a> &raquo;</li>
          <li><a href="other_features.html">Other features</a> &raquo;</li>
      <li>IP Transparency</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/intro/arch_overview/other_features/ip_transparency.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="ip-transparency">
<span id="arch-overview-ip-transparency"></span><h1>IP Transparency<a class="headerlink" href="#ip-transparency" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-ip-transparency">
<h2>What is IP Transparency<a class="headerlink" href="#what-is-ip-transparency" title="Permalink to this headline">¶</a></h2>
<p>As a proxy, Envoy is an IP endpoint: it has its own IP address, distinct from that of any downstream
requests. Consequently, when Envoy establishes connections to upstream hosts, the IP address of that
connection will be different from that of any proxied connections.</p>
<p>Sometimes the upstream server or network may need to know the original IP address of the connection,
called the <em>downstream remote address</em>, for many reasons. Some examples include:</p>
<ul class="simple">
<li><p>the IP address being used to form part of an identity,</p></li>
<li><p>the IP address being used to enforce network policy, or</p></li>
<li><p>the IP address being included in an audit.</p></li>
</ul>
<p>Envoy supports multiple methods for providing the downstream remote address to the upstream host.
These techniques vary in complexity and applicability.</p>
<p>Envoy also supports
<a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-original-ip-detection-extensions"><span class="std std-ref">extensions</span></a>
for detecting the original IP address. This might be useful if none of the techniques below is
applicable to your setup. Two available extensions are the <a class="reference internal" href="../../../api-v3/extensions/http/original_ip_detection/custom_header/v3/custom_header.proto.html#envoy-v3-api-msg-extensions-http-original-ip-detection-custom-header-v3-customheaderconfig"><span class="std std-ref">custom header</span></a>
extension and the <a class="reference internal" href="../../../api-v3/extensions/http/original_ip_detection/xff/v3/xff.proto.html#envoy-v3-api-msg-extensions-http-original-ip-detection-xff-v3-xffconfig"><span class="std std-ref">xff</span></a>
extension.</p>
</div>
<div class="section" id="http-headers">
<h2>HTTP Headers<a class="headerlink" href="#http-headers" title="Permalink to this headline">¶</a></h2>
<p>HTTP headers may carry the original IP address of the request in the
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a> header. The upstream server
can use this header to determine the downstream remote address. Envoy may also use this header to
choose the IP address used by the
<a class="reference internal" href="#arch-overview-ip-transparency-original-src-http"><span class="std std-ref">Original Src HTTP Filter</span></a>.</p>
<p>The HTTP header approach has a few downsides:</p>
<ul class="simple">
<li><p>It is only applicable to HTTP.</p></li>
<li><p>It may not be supported by the upstream host.</p></li>
<li><p>It requires careful configuration.</p></li>
</ul>
</div>
<div class="section" id="proxy-protocol">
<h2>Proxy Protocol<a class="headerlink" href="#proxy-protocol" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://www.haproxy.org/download/1.9/doc/proxy-protocol.txt">HAProxy Proxy Protocol</a> defines a
protocol for communicating metadata about a connection over TCP, prior to the main TCP stream. This
metadata includes the source IP. Envoy supports consuming this information using
<a class="reference internal" href="../../../configuration/listeners/listener_filters/proxy_protocol.html#config-listener-filters-proxy-protocol"><span class="std std-ref">Proxy Protocol filter</span></a>, which may be used to recover
the downstream remote address for propagation into an
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a> header. It can also be used in
conjunction with the
<a class="reference internal" href="#arch-overview-ip-transparency-original-src-listener"><span class="std std-ref">Original Src Listener Filter</span></a>. Finally,
Envoy supports generating this header using the <a class="reference internal" href="../../../api-v3/extensions/transport_sockets/proxy_protocol/v3/upstream_proxy_protocol.proto.html#extension-envoy-transport-sockets-upstream-proxy-protocol"><span class="std std-ref">Proxy Protocol Transport Socket</span></a>.</p>
<p>Here is an example config for setting up the socket:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">clusters</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service1</span><span class="w"></span>
<span class="w">  </span><span class="nt">connect_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.25s</span><span class="w"></span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">strict_dns</span><span class="w"></span>
<span class="w">  </span><span class="nt">lb_policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">round_robin</span><span class="w"></span>
<span class="w">  </span><span class="nt">transport_socket</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.transport_sockets.upstream_proxy_protocol</span><span class="w"></span>
<span class="w">    </span><span class="nt">typed_config</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.transport_sockets.proxy_protocol.v3.ProxyProtocolUpstreamTransport</span><span class="w"></span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">V1</span><span class="w"></span>
<span class="w">      </span><span class="nt">transport_socket</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.transport_sockets.raw_buffer</span><span class="w"></span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
</pre></div>
</div>
<p>There are several things to consider if you plan to use this socket in conjunction with the
<a class="reference internal" href="../../../configuration/http/http_conn_man/http_conn_man.html#config-http-conn-man"><span class="std std-ref">HTTP connection manager</span></a>. There will be a performance hit as there will be no upstream connection
re-use among downstream clients. Every client that connects to Envoy will get a new connection to the upstream server.
This is due to the nature of proxy protocol being a connection based protocol. Downstream client info is only forwarded to the
upstream at the start of a connection before any other data has been sent (Note: this includes before a TLS handshake occurs).
If possible, using the <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a> header should be preferred as Envoy
will be able to re-use upstream connections with this method. Due to the disconnect between Envoy’s handling of downstream and upstream
connections, it is a good idea to enforce short <a class="reference internal" href="../../../faq/configuration/timeouts.html#faq-configuration-timeouts"><span class="std std-ref">idle timeouts</span></a> on upstream connections as
Envoy will not inherently close a corresponding upstream connection when a downstream connection is closed.</p>
<p>Some drawbacks to Proxy Protocol:</p>
<ul class="simple">
<li><p>It only supports TCP protocols.</p></li>
<li><p>It requires upstream host support.</p></li>
</ul>
</div>
<div class="section" id="original-source-listener-filter">
<span id="arch-overview-ip-transparency-original-src-listener"></span><h2>Original Source Listener Filter<a class="headerlink" href="#original-source-listener-filter" title="Permalink to this headline">¶</a></h2>
<p>In controlled deployments, it may be possible to replicate the downstream remote address on the
upstream connection by using a
<a class="reference internal" href="../../../configuration/listeners/listener_filters/original_src_filter.html#config-listener-filters-original-src"><span class="std std-ref">Original Source listener filter</span></a>. No metadata is added
to the upstream request or stream. Rather, the upstream connection itself will be established with
the downstream remote address as its source address. This filter will work with any upstream
protocol or host. However, it requires fairly complex configuration, and it may not be supported in
all deployments due to routing constraints.</p>
<p>Some drawbacks to the Original Source filter:</p>
<ul class="simple">
<li><p>It requires that Envoy have access to the downstream remote address.</p></li>
<li><p>Its configuration is relatively complex.</p></li>
<li><p>It may introduce a slight performance hit due to restrictions on connection pooling.</p></li>
<li><p>Not supported on Windows.</p></li>
</ul>
</div>
<div class="section" id="original-source-http-filter">
<span id="arch-overview-ip-transparency-original-src-http"></span><h2>Original Source HTTP Filter<a class="headerlink" href="#original-source-http-filter" title="Permalink to this headline">¶</a></h2>
<p>In controlled deployments, it may be possible to replicate the downstream remote address on the
upstream connection by using a
<a class="reference internal" href="../../../configuration/http/http_filters/original_src_filter.html#config-http-filters-original-src"><span class="std std-ref">Original Source HTTP filter</span></a>. This filter operates much like
the <a class="reference internal" href="#arch-overview-ip-transparency-original-src-listener"><span class="std std-ref">Original Src Listener Filter</span></a>. The
main difference is that it can infer the original source address from HTTP headers, which is important
for cases where a single downstream connection carries multiple HTTP requests from different original
source addresses. Deployments with a front proxy forwarding to sidecar proxies are examples where case
applies.</p>
<p>This filter will work with any upstream HTTP host. However, it requires fairly complex configuration,
and it may not be supported in all deployments due to routing constraints.</p>
<p>Some drawbacks to the Original Source filter:</p>
<ul class="simple">
<li><p>It requires that Envoy be properly configured to extract the downstream remote address from the
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a> header.</p></li>
<li><p>Its configuration is relatively complex.</p></li>
<li><p>It may introduce a slight performance hit due to restrictions on connection pooling.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature is not supported on Windows.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="scripting.html" class="btn btn-neutral float-left" title="Scripting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="compression/libraries.html" class="btn btn-neutral float-right" title="Compression Libraries" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, Envoy Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>