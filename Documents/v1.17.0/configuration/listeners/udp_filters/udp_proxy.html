

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>UDP proxy &mdash; envoy 1.17.0-5c801b documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="DNS Filter" href="dns_filter.html" />
    <link rel="prev" title="UDP listener filters" href="udp_filters.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-5c801b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../listeners.html">Listeners</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stats.html">Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runtime.html">Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listener_filters/listener_filters.html">Listener filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../network_filters/network_filters.html">Network filters</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="udp_filters.html">UDP listener filters</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">UDP proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="dns_filter.html">DNS Filter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../lds.html">Listener discovery service (LDS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../listeners.html">Listeners</a> &raquo;</li>
        
          <li><a href="udp_filters.html">UDP listener filters</a> &raquo;</li>
        
      <li>UDP proxy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/listeners/udp_filters/udp_proxy.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="udp-proxy">
<span id="config-udp-listener-filters-udp-proxy"></span><h1>UDP proxy<a class="headerlink" href="#udp-proxy" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/udp/udp_proxy/v3/udp_proxy.proto.html#envoy-v3-api-msg-extensions-filters-udp-udp-proxy-v3-udpproxyconfig"><span class="std std-ref">v3 API reference</span></a></p></li>
<li><p>This filter should be configured with the name <em>envoy.filters.udp_listener.udp_proxy</em></p></li>
</ul>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The UDP proxy listener filter allows Envoy to operate as a <em>non-transparent</em> proxy between a
UDP client and server. The lack of transparency means that the upstream server will see the
source IP and port of the Envoy instance versus the client. All datagrams flow from the client, to
Envoy, to the upstream server, back to Envoy, and back to the client.</p>
<p>Because UDP is not a connection oriented protocol, Envoy must keep track of a client’s <em>session</em>
such that the response datagrams from an upstream server can be routed back to the correct client.
Each session is index by the 4-tuple consisting of source IP/port and local IP/port that the
datagram is received on. Sessions last until the <a class="reference internal" href="../../../api-v3/extensions/filters/udp/udp_proxy/v3/udp_proxy.proto.html#envoy-v3-api-field-extensions-filters-udp-udp-proxy-v3-udpproxyconfig-idle-timeout"><span class="std std-ref">idle timeout</span></a> is reached.</p>
<p>The UDP proxy listener filter also can operate as a <em>transparent</em> proxy if the
<a class="reference internal" href="../../../api-v3/extensions/filters/udp/udp_proxy/v3/udp_proxy.proto.html#envoy-v3-api-msg-extensions-filters-udp-udp-proxy-v3-udpproxyconfig"><span class="std std-ref">use_original_src_ip</span></a>
field is set. But please keep in mind that it does not forward the port to upstreams. It forwards only the IP address to upstreams.</p>
</div>
<div class="section" id="load-balancing-and-unhealthy-host-handling">
<h2>Load balancing and unhealthy host handling<a class="headerlink" href="#load-balancing-and-unhealthy-host-handling" title="Permalink to this headline">¶</a></h2>
<p>Envoy will fully utilize the configured load balancer for the configured upstream cluster when
load balancing UDP datagrams. When a new session is created, Envoy will associate the session
with an upstream host selected using the configured load balancer. All future datagrams that
belong to the session will be routed to the same upstream host.</p>
<p>When an upstream host becomes unhealthy (due to <a class="reference internal" href="../../../intro/arch_overview/upstream/health_checking.html#arch-overview-health-checking"><span class="std std-ref">active health checking</span></a>), Envoy will attempt to create a new session to a healthy host
when the next datagram is received.</p>
</div>
<div class="section" id="circuit-breaking">
<h2>Circuit breaking<a class="headerlink" href="#circuit-breaking" title="Permalink to this headline">¶</a></h2>
<p>The number of sessions that can be created per upstream cluster is limited by the cluster’s
<a class="reference internal" href="../../../intro/arch_overview/upstream/circuit_breaking.html#arch-overview-circuit-break-cluster-maximum-connections"><span class="std std-ref">maximum connection circuit breaker</span></a>.
By default this is 1024.</p>
</div>
<div class="section" id="example-configuration">
<h2>Example configuration<a class="headerlink" href="#example-configuration" title="Permalink to this headline">¶</a></h2>
<p>The following example configuration will cause Envoy to listen on UDP port 1234 and proxy to a UDP
server listening on port 1235.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">admin</span><span class="p">:</span>
  <span class="nt">access_log_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/admin_access.log</span>
  <span class="nt">address</span><span class="p">:</span>
    <span class="nt">socket_address</span><span class="p">:</span>
      <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
      <span class="nt">port_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">9901</span>
<span class="nt">static_resources</span><span class="p">:</span>
  <span class="nt">listeners</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">listener_0</span>
    <span class="nt">reuse_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">address</span><span class="p">:</span>
      <span class="nt">socket_address</span><span class="p">:</span>
        <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">UDP</span>
        <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
        <span class="nt">port_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1234</span>
    <span class="nt">listener_filters</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.udp_listener.udp_proxy</span>
      <span class="nt">typed_config</span><span class="p">:</span>
        <span class="s">&#39;@type&#39;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.udp.udp_proxy.v3.UdpProxyConfig</span>
        <span class="nt">stat_prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">service</span>
        <span class="nt">cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">service_udp</span>
  <span class="nt">clusters</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">service_udp</span>
    <span class="nt">connect_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.25s</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">STATIC</span>
    <span class="nt">lb_policy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ROUND_ROBIN</span>
    <span class="nt">load_assignment</span><span class="p">:</span>
      <span class="nt">cluster_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">service_udp</span>
      <span class="nt">endpoints</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">lb_endpoints</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">endpoint</span><span class="p">:</span>
            <span class="nt">address</span><span class="p">:</span>
              <span class="nt">socket_address</span><span class="p">:</span>
                <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
                <span class="nt">port_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1235</span>
</pre></div>
</div>
</div>
<div class="section" id="statistics">
<h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h2>
<p>The UDP proxy filter emits both its own downstream statistics as well as many of the <a class="reference internal" href="../../upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats"><span class="std std-ref">cluster
upstream statistics</span></a> where applicable. The downstream
statistics are rooted at <em>udp.&lt;stat_prefix&gt;.</em> with the following statistics:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>downstream_sess_no_route</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagrams not routed due to no cluster</p></td>
</tr>
<tr class="row-odd"><td><p>downstream_sess_rx_bytes</p></td>
<td><p>Counter</p></td>
<td><p>Number of bytes received</p></td>
</tr>
<tr class="row-even"><td><p>downstream_sess_rx_datagrams</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagrams received</p></td>
</tr>
<tr class="row-odd"><td><p>downstream_sess_rx_errors</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagram receive errors</p></td>
</tr>
<tr class="row-even"><td><p>downstream_sess_total</p></td>
<td><p>Counter</p></td>
<td><p>Number sessions created in total</p></td>
</tr>
<tr class="row-odd"><td><p>downstream_sess_tx_bytes</p></td>
<td><p>Counter</p></td>
<td><p>Number of bytes transmitted</p></td>
</tr>
<tr class="row-even"><td><p>downstream_sess_tx_datagrams</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagrams transmitted</p></td>
</tr>
<tr class="row-odd"><td><p>downstream_sess_tx_errors</p></td>
<td><p>counter</p></td>
<td><p>Number of datagram transmission errors</p></td>
</tr>
<tr class="row-even"><td><p>idle_timeout</p></td>
<td><p>Counter</p></td>
<td><p>Number of sessions destroyed due to idle timeout</p></td>
</tr>
<tr class="row-odd"><td><p>downstream_sess_active</p></td>
<td><p>Gauge</p></td>
<td><p>Number of sessions currently active</p></td>
</tr>
</tbody>
</table>
<p>The following standard <a class="reference internal" href="../../upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats"><span class="std std-ref">upstream cluster stats</span></a> are used
by the UDP proxy:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>upstream_cx_none_healthy</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagrams dropped due to no healthy hosts</p></td>
</tr>
<tr class="row-odd"><td><p>upstream_cx_overflow</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagrams dropped due to hitting the session circuit breaker</p></td>
</tr>
<tr class="row-even"><td><p>upstream_cx_rx_bytes_total</p></td>
<td><p>Counter</p></td>
<td><p>Number of bytes received</p></td>
</tr>
<tr class="row-odd"><td><p>upstream_cx_tx_bytes_total</p></td>
<td><p>Counter</p></td>
<td><p>Number of bytes transmitted</p></td>
</tr>
</tbody>
</table>
<p>The UDP proxy filter also emits custom upstream cluster stats prefixed with
<em>cluster.&lt;cluster_name&gt;.udp.</em>:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>sess_rx_datagrams</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagrams received</p></td>
</tr>
<tr class="row-odd"><td><p>sess_rx_errors</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagram receive errors</p></td>
</tr>
<tr class="row-even"><td><p>sess_tx_datagrams</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagrams transmitted</p></td>
</tr>
<tr class="row-odd"><td><p>sess_tx_errors</p></td>
<td><p>Counter</p></td>
<td><p>Number of datagrams tramsitted</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dns_filter.html" class="btn btn-neutral float-right" title="DNS Filter" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="udp_filters.html" class="btn btn-neutral float-left" title="UDP listener filters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>