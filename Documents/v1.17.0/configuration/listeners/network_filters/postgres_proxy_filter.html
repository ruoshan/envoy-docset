

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Postgres proxy &mdash; envoy 1.17.0-5c801b documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Rate limit" href="rate_limit_filter.html" />
    <link rel="prev" title="MySQL proxy" href="mysql_proxy_filter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-5c801b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../listeners.html">Listeners</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stats.html">Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runtime.html">Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listener_filters/listener_filters.html">Listener filters</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="network_filters.html">Network filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="dubbo_proxy_filter.html">Dubbo proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="client_ssl_auth_filter.html">Client TLS authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="echo_filter.html">Echo</a></li>
<li class="toctree-l4"><a class="reference internal" href="direct_response_filter.html">Direct response</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="kafka_broker_filter.html">Kafka Broker filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_rate_limit_filter.html">Local rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="mongo_proxy_filter.html">Mongo proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="mysql_proxy_filter.html">MySQL proxy</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Postgres proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Network Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="redis_proxy_filter.html">Redis proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="rocketmq_proxy_filter.html">RocketMQ proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="tcp_proxy_filter.html">TCP proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="thrift_proxy_filter.html">Thrift proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="sni_cluster_filter.html">Upstream Cluster from SNI</a></li>
<li class="toctree-l4"><a class="reference internal" href="sni_dynamic_forward_proxy_filter.html">SNI dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="wasm_filter.html">Wasm Network Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="zookeeper_proxy_filter.html">ZooKeeper proxy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../udp_filters/udp_filters.html">UDP listener filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lds.html">Listener discovery service (LDS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../listeners.html">Listeners</a> &raquo;</li>
        
          <li><a href="network_filters.html">Network filters</a> &raquo;</li>
        
      <li>Postgres proxy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/listeners/network_filters/postgres_proxy_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="postgres-proxy">
<span id="config-network-filters-postgres-proxy"></span><h1>Postgres proxy<a class="headerlink" href="#postgres-proxy" title="Permalink to this headline">¶</a></h1>
<p>The Postgres proxy filter decodes the wire protocol between a Postgres client (downstream) and a Postgres server
(upstream). The decoded information is used to produce Postgres level statistics like sessions,
statements or transactions executed, among others. The Postgres proxy filter parses SQL queries carried in <code class="docutils literal notranslate"><span class="pre">Query</span></code> and <code class="docutils literal notranslate"><span class="pre">Parse</span></code> messages.
When SQL query has been parsed successfully, the <a class="reference internal" href="#config-network-filters-postgres-proxy-dynamic-metadata"><span class="std std-ref">metadata</span></a> is created,
which may be used by other filters like <a class="reference internal" href="rbac_filter.html#config-network-filters-rbac"><span class="std std-ref">RBAC</span></a>.
When the Postgres filter detects that a session is encrypted, the messages are ignored and no decoding takes
place. More information:</p>
<ul class="simple">
<li><p>Postgres <a class="reference internal" href="../../../intro/arch_overview/other_protocols/postgres.html#arch-overview-postgres"><span class="std std-ref">architecture overview</span></a></p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The <cite>postgres_proxy</cite> filter is experimental and is currently under active development.
Capabilities will be expanded over time and the configuration structures are likely to change.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <cite>postgreql_proxy</cite> filter was tested only with
<a class="reference external" href="https://www.postgresql.org/docs/current/protocol.html">Postgres frontend/backend protocol version 3.0</a>, which was introduced in
Postgres 7.4. Earlier versions are thus not supported. Testing is limited
anyway to not EOL-ed versions.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>The Postgres proxy filter should be chained with the TCP proxy as shown in the configuration
example below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">filter_chains</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">filters</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.network.postgres_proxy</span>
    <span class="nt">typed_config</span><span class="p">:</span>
      <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.network.postgres_proxy.v3alpha.PostgresProxy</span>
      <span class="nt">stat_prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.tcp_proxy</span>
    <span class="nt">typed_config</span><span class="p">:</span>
      <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy</span>
      <span class="nt">stat_prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tcp</span>
      <span class="nt">cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres_cluster</span>
</pre></div>
</div>
</div>
<div class="section" id="statistics">
<span id="config-network-filters-postgres-proxy-stats"></span><h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h2>
<p>Every configured Postgres proxy filter has statistics rooted at postgres.&lt;stat_prefix&gt; with the following statistics:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 20%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>errors</p></td>
<td><p>Counter</p></td>
<td><p>Number of times the server replied with ERROR message</p></td>
</tr>
<tr class="row-odd"><td><p>errors_error</p></td>
<td><p>Counter</p></td>
<td><p>Number of times the server replied with ERROR message with ERROR severity</p></td>
</tr>
<tr class="row-even"><td><p>errors_fatal</p></td>
<td><p>Counter</p></td>
<td><p>Number of times the server replied with ERROR message with FATAL severity</p></td>
</tr>
<tr class="row-odd"><td><p>errors_panic</p></td>
<td><p>Counter</p></td>
<td><p>Number of times the server replied with ERROR message with PANIC severity</p></td>
</tr>
<tr class="row-even"><td><p>errors_unknown</p></td>
<td><p>Counter</p></td>
<td><p>Number of times the server replied with ERROR message but the decoder could not parse it</p></td>
</tr>
<tr class="row-odd"><td><p>messages</p></td>
<td><p>Counter</p></td>
<td><p>Total number of messages processed by the filter</p></td>
</tr>
<tr class="row-even"><td><p>messages_backend</p></td>
<td><p>Counter</p></td>
<td><p>Total number of backend messages detected by the filter</p></td>
</tr>
<tr class="row-odd"><td><p>messages_frontend</p></td>
<td><p>Counter</p></td>
<td><p>Number of frontend messages detected by the filter</p></td>
</tr>
<tr class="row-even"><td><p>messages_unknown</p></td>
<td><p>Counter</p></td>
<td><p>Number of times the filter successfully decoded a message but did not know what to do with it</p></td>
</tr>
<tr class="row-odd"><td><p>sessions</p></td>
<td><p>Counter</p></td>
<td><p>Total number of successful logins</p></td>
</tr>
<tr class="row-even"><td><p>sessions_encrypted</p></td>
<td><p>Counter</p></td>
<td><p>Number of times the filter detected encrypted sessions</p></td>
</tr>
<tr class="row-odd"><td><p>sessions_unencrypted</p></td>
<td><p>Counter</p></td>
<td><p>Number of messages indicating unencrypted successful login</p></td>
</tr>
<tr class="row-even"><td><p>statements</p></td>
<td><p>Counter</p></td>
<td><p>Total number of SQL statements</p></td>
</tr>
<tr class="row-odd"><td><p>statements_delete</p></td>
<td><p>Counter</p></td>
<td><p>Number of DELETE statements</p></td>
</tr>
<tr class="row-even"><td><p>statements_insert</p></td>
<td><p>Counter</p></td>
<td><p>Number of INSERT statements</p></td>
</tr>
<tr class="row-odd"><td><p>statements_select</p></td>
<td><p>Counter</p></td>
<td><p>Number of SELECT statements</p></td>
</tr>
<tr class="row-even"><td><p>statements_update</p></td>
<td><p>Counter</p></td>
<td><p>Number of UPDATE statements</p></td>
</tr>
<tr class="row-odd"><td><p>statements_other</p></td>
<td><p>Counter</p></td>
<td><p>Number of statements other than DELETE, INSERT, SELECT or UPDATE</p></td>
</tr>
<tr class="row-even"><td><p>statements_parsed</p></td>
<td><p>Counter</p></td>
<td><p>Number of SQL queries parsed successfully</p></td>
</tr>
<tr class="row-odd"><td><p>statements_parse_error</p></td>
<td><p>Counter</p></td>
<td><p>Number of SQL queries not parsed successfully</p></td>
</tr>
<tr class="row-even"><td><p>transactions</p></td>
<td><p>Counter</p></td>
<td><p>Total number of SQL transactions</p></td>
</tr>
<tr class="row-odd"><td><p>transactions_commit</p></td>
<td><p>Counter</p></td>
<td><p>Number of COMMIT transactions</p></td>
</tr>
<tr class="row-even"><td><p>transactions_rollback</p></td>
<td><p>Counter</p></td>
<td><p>Number of ROLLBACK transactions</p></td>
</tr>
<tr class="row-odd"><td><p>notices</p></td>
<td><p>Counter</p></td>
<td><p>Total number of NOTICE messages</p></td>
</tr>
<tr class="row-even"><td><p>notices_notice</p></td>
<td><p>Counter</p></td>
<td><p>Number of NOTICE messages with NOTICE subtype</p></td>
</tr>
<tr class="row-odd"><td><p>notices_log</p></td>
<td><p>Counter</p></td>
<td><p>Number of NOTICE messages with LOG subtype</p></td>
</tr>
<tr class="row-even"><td><p>notices_warning</p></td>
<td><p>Counter</p></td>
<td><p>Number ofr NOTICE messags with WARNING severity</p></td>
</tr>
<tr class="row-odd"><td><p>notices_debug</p></td>
<td><p>Counter</p></td>
<td><p>Number of NOTICE messages with DEBUG severity</p></td>
</tr>
<tr class="row-even"><td><p>notices_info</p></td>
<td><p>Counter</p></td>
<td><p>Number of NOTICE messages with INFO severity</p></td>
</tr>
<tr class="row-odd"><td><p>notices_unknown</p></td>
<td><p>Counter</p></td>
<td><p>Number of NOTICE messages which could not be recognized</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="dynamic-metadata">
<span id="config-network-filters-postgres-proxy-dynamic-metadata"></span><h2>Dynamic Metadata<a class="headerlink" href="#dynamic-metadata" title="Permalink to this headline">¶</a></h2>
<p>The Postgres filter emits Dynamic Metadata based on SQL statements carried in <code class="docutils literal notranslate"><span class="pre">Query</span></code> and <code class="docutils literal notranslate"><span class="pre">Parse</span></code> messages. <code class="docutils literal notranslate"><span class="pre">statements_parsed</span></code> statistics Counter tracks how many times
SQL statement was parsed successfully and metadata was created. The metadata is emitted in the following format:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&lt;table.db&gt;</p></td>
<td><p>string</p></td>
<td><p>The resource name in <em>table.db</em> format.</p></td>
</tr>
<tr class="row-odd"><td><p>[]</p></td>
<td><p>list</p></td>
<td><p>A list of strings representing the operations executed on the resource. Operations can be one of insert/update/select/drop/delete/create/alter/show.</p></td>
</tr>
</tbody>
</table>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Currently used parser does not successfully parse all SQL statements and it cannot be assumed that all SQL queries will successfully produce Dynamic Metadata.
Creating Dynamic Metadata from SQL queries is on best-effort basis at the moment. If parsing of an SQL query fails, <code class="docutils literal notranslate"><span class="pre">statements_parse_error</span></code> counter is increased, log message is created, Dynamic Metadata is not
produced, but the Postgres message is still forwarded to upstream Postgres server.</p>
</div>
<p>Parsing SQL statements and emitting Dynamic Metadata can be disabled by setting <a class="reference internal" href="../../../api-v3/extensions/filters/network/postgres_proxy/v3alpha/postgres_proxy.proto.html#envoy-v3-api-field-extensions-filters-network-postgres-proxy-v3alpha-postgresproxy-enable-sql-parsing"><span class="std std-ref">enable_sql_parsing</span></a> to false.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rate_limit_filter.html" class="btn btn-neutral float-right" title="Rate limit" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mysql_proxy_filter.html" class="btn btn-neutral float-left" title="MySQL proxy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>