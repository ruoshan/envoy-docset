

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CSRF &mdash; envoy 1.17.0-5c801b documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Decompressor" href="decompressor_filter.html" />
    <link rel="prev" title="CORS" href="cors_filter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-5c801b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="adaptive_concurrency_filter.html">Adaptive Concurrency</a></li>
<li class="toctree-l4"><a class="reference internal" href="admission_control_filter.html">Admission Control</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_lambda_filter.html">AWS Lambda</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_request_signing_filter.html">AWS Request Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="cdn_loop_filter.html">CDN-Loop header</a></li>
<li class="toctree-l4"><a class="reference internal" href="compressor_filter.html">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">CSRF</a></li>
<li class="toctree-l4"><a class="reference internal" href="decompressor_filter.html">Decompressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_proc_filter.html">External Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_stats_filter.html">gRPC Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="gzip_filter.html">Gzip</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l4"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="kill_request_filter.html">Kill Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_rate_limit_filter.html">Local rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="lua_filter.html">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="oauth2_filter.html">OAuth2</a></li>
<li class="toctree-l4"><a class="reference internal" href="on_demand_updates_filter.html">On-demand VHDS and S/RDS Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="router_filter.html">Router</a></li>
<li class="toctree-l4"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l4"><a class="reference internal" href="tap_filter.html">Tap</a></li>
<li class="toctree-l4"><a class="reference internal" href="wasm_filter.html">Wasm</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../http.html">HTTP</a> &raquo;</li>
        
          <li><a href="http_filters.html">HTTP filters</a> &raquo;</li>
        
      <li>CSRF</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/http/http_filters/csrf_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="csrf">
<span id="config-http-filters-csrf"></span><h1>CSRF<a class="headerlink" href="#csrf" title="Permalink to this headline">¶</a></h1>
<p>This is a filter which prevents Cross-Site Request Forgery based on a route or virtual host settings.
At it’s simplest, CSRF is an attack that occurs when a malicious third-party
exploits a vulnerability that allows them to submit an undesired request on the
user’s behalf.</p>
<p>A real-life example is cited in section 1 of <a class="reference external" href="https://seclab.stanford.edu/websec/csrf/csrf.pdf">Robust Defenses for Cross-Site Request Forgery</a>:</p>
<blockquote>
<div><p>“For example, in late 2007 [42], Gmail had a CSRF vulnerability. When a Gmail user visited
a malicious site, the malicious site could generate a request to Gmail that Gmail treated
as part of its ongoing session with the victim. In November 2007, a web attacker exploited
this CSRF vulnerability to inject an email filter into David Airey’s Gmail account [1].”</p>
</div></blockquote>
<p>There are many ways to mitigate CSRF, some of which have been outlined in the
<a class="reference external" href="https://github.com/OWASP/CheatSheetSeries/blob/5a1044e38778b42a19c6adbb4dfef7a0fb071099/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md">OWASP Prevention Cheat Sheet</a>.
This filter employs a stateless mitigation pattern known as origin verification.</p>
<p>This pattern relies on two pieces of information used in determining if
a request originated from the same host.
* The origin that caused the user agent to issue the request (source origin).
* The origin that the request is going to (target origin).</p>
<p>When the filter is evaluating a request, it ensures both pieces of information are present
and compares their values. If the source origin is missing or the origins do not match
the request is rejected. The exception to this being if the source origin has been
added to the policy as valid. Because CSRF attacks specifically target state-changing
requests, the filter only acts on HTTP requests that have a state-changing method
(POST, PUT, etc.).</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Due to differing functionality between browsers this filter will determine
a request’s source origin from the Origin header. If that is not present it will
fall back to the host and port value from the requests Referer header.</p>
</div>
</div></blockquote>
<p>For more information on CSRF please refer to the pages below.</p>
<ul>
<li><p><a class="reference external" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29">https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29</a></p></li>
<li><p><a class="reference external" href="https://seclab.stanford.edu/websec/csrf/csrf.pdf">https://seclab.stanford.edu/websec/csrf/csrf.pdf</a></p></li>
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/csrf/v3/csrf.proto.html#envoy-v3-api-msg-extensions-filters-http-csrf-v3-csrfpolicy"><span class="std std-ref">v3 API reference</span></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This filter should be configured with the name <em>envoy.filters.http.csrf</em>.</p>
</div>
</li>
</ul>
<div class="section" id="configuration">
<span id="csrf-configuration"></span><h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>The CSRF filter supports the ability to extend the source origins it will consider
valid. The reason it is able to do this while still mitigating cross-site request
forgery attempts is because the target origin has already been reached by the time
front-envoy is applying the filter. This means that while endpoints may support
cross-origin requests they are still protected from malicious third-parties who
have not been allowlisted.</p>
<p>It’s important to note that requests should generally originate from the same
origin as the target but there are use cases where that may not be possible.
For example, if you are hosting a static site on a third-party vendor but need
to make requests for tracking purposes.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Additional origins can be either an exact string, regex pattern, prefix string,
or suffix string. It’s advised to be cautious when adding regex, prefix, or suffix
origins since an ambiguous origin can pose a security vulnerability.</p>
</div>
</div>
<div class="section" id="runtime">
<span id="csrf-runtime"></span><h2>Runtime<a class="headerlink" href="#runtime" title="Permalink to this headline">¶</a></h2>
<p>The fraction of requests for which the filter is enabled can be configured via the <a class="reference internal" href="../../../api-v3/config/core/v3/base.proto.html#envoy-v3-api-field-config-core-v3-runtimefractionalpercent-runtime-key"><span class="std std-ref">runtime_key</span></a> value of the <a class="reference internal" href="../../../api-v3/extensions/filters/http/csrf/v3/csrf.proto.html#envoy-v3-api-field-extensions-filters-http-csrf-v3-csrfpolicy-filter-enabled"><span class="std std-ref">filter_enabled</span></a> field.</p>
<p>The fraction of requests for which the filter is enabled in shadow-only mode can be configured via
the <a class="reference internal" href="../../../api-v3/config/core/v3/base.proto.html#envoy-v3-api-field-config-core-v3-runtimefractionalpercent-runtime-key"><span class="std std-ref">runtime_key</span></a> value of the
<a class="reference internal" href="../../../api-v3/extensions/filters/http/csrf/v3/csrf.proto.html#envoy-v3-api-field-extensions-filters-http-csrf-v3-csrfpolicy-shadow-enabled"><span class="std std-ref">shadow_enabled</span></a> field.
When enabled in shadow-only mode, the filter will evaluate the request’s <em>Origin</em> and <em>Destination</em>
to determine if it’s valid but will not enforce any policies.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If both <code class="docutils literal notranslate"><span class="pre">filter_enabled</span></code> and <code class="docutils literal notranslate"><span class="pre">shadow_enabled</span></code> are on, the <code class="docutils literal notranslate"><span class="pre">filter_enabled</span></code>
flag will take precedence.</p>
</div>
</div>
<div class="section" id="statistics">
<span id="csrf-statistics"></span><h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h2>
<p>The CSRF filter outputs statistics in the &lt;stat_prefix&gt;.csrf.* namespace.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>missing_source_origin</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests that are missing a source origin header.</p></td>
</tr>
<tr class="row-odd"><td><p>request_invalid</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests whose source and target origins do not match.</p></td>
</tr>
<tr class="row-even"><td><p>request_valid</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests whose source and target origins match.</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="decompressor_filter.html" class="btn btn-neutral float-right" title="Decompressor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cors_filter.html" class="btn btn-neutral float-left" title="CORS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>