

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Virtual Host Discovery Service (VHDS) &mdash; envoy 1.17.0-5c801b documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="HTTP filters" href="../http_filters/http_filters.html" />
    <link rel="prev" title="Route discovery service (RDS)" href="rds.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-5c801b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="http_conn_man.html">HTTP connection manager</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="route_matching.html">Route matching</a></li>
<li class="toctree-l4"><a class="reference internal" href="traffic_splitting.html">Traffic Shifting/Splitting</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_casing.html">HTTP/1.1 Header Casing</a></li>
<li class="toctree-l4"><a class="reference internal" href="headers.html">HTTP header manipulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_sanitizing.html">HTTP header sanitizing</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_reply.html">Local reply modification</a></li>
<li class="toctree-l4"><a class="reference internal" href="response_code_details.html">Response Code Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="stats.html">Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="runtime.html">Runtime</a></li>
<li class="toctree-l4"><a class="reference internal" href="rds.html">Route discovery service (RDS)</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Virtual Host Discovery Service (VHDS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../http_filters/http_filters.html">HTTP filters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../http.html">HTTP</a> &raquo;</li>
        
          <li><a href="http_conn_man.html">HTTP connection manager</a> &raquo;</li>
        
      <li>Virtual Host Discovery Service (VHDS)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/http/http_conn_man/vhds.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="virtual-host-discovery-service-vhds">
<span id="config-http-conn-man-vhds"></span><h1>Virtual Host Discovery Service (VHDS)<a class="headerlink" href="#virtual-host-discovery-service-vhds" title="Permalink to this headline">¶</a></h1>
<p>The virtual host discovery service (VHDS) API is an optional API that Envoy will call to
dynamically fetch <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-msg-config-route-v3-virtualhost"><span class="std std-ref">virtual hosts</span></a>. A virtual host includes
a name and set of domains that get routed to it based on the incoming request’s host header.</p>
<p>By default in RDS, all routes for a cluster are sent to every Envoy instance in the mesh. This
causes scaling issues as the size of the cluster grows. The majority of this complexity can be
found in the virtual host configurations, of which most are not needed by any individual proxy.</p>
<p>In order to fix this issue, the Virtual Host Discovery Service (VHDS) protocol uses the delta xDS
protocol to allow a route configuration to be subscribed to and the necessary virtual hosts to be
requested as needed. Instead of sending all virtual hosts with a route config, using VHDS will
allow an Envoy instance to subscribe and unsubscribe from a list of virtual hosts stored internally
in the xDS management server. The xDS management server will monitor this list and use it to filter
the configuration sent to an individual Envoy instance to only contain the subscribed virtual hosts.</p>
<div class="section" id="virtual-host-resource-naming-convention">
<h2>Virtual Host Resource Naming Convention<a class="headerlink" href="#virtual-host-resource-naming-convention" title="Permalink to this headline">¶</a></h2>
<p>Virtual hosts in VHDS are identified by a combination of the name of the route configuration to
which the virtual host belongs as well as the HTTP <em>host</em> header (<em>:authority</em> for HTTP2) entry.
Resources should be named as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">route</span> <span class="n">configuration</span> <span class="n">name</span><span class="o">&gt;/&lt;</span><span class="n">host</span> <span class="n">entry</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Note that matching should be done from right to left since a host entry cannot contain slashes while
a route configuration name can.</p>
</div>
<div class="section" id="subscribing-to-resources">
<h2>Subscribing to Resources<a class="headerlink" href="#subscribing-to-resources" title="Permalink to this headline">¶</a></h2>
<p>VHDS allows resources to be <a class="reference internal" href="../../../api-docs/xds_protocol.html#xds-protocol-delta-subscribe"><span class="std std-ref">subscribed</span></a> to using a
<a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-msg-service-discovery-v3-deltadiscoveryrequest"><span class="std std-ref">DeltaDiscoveryRequest</span></a> with the
<a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-field-service-discovery-v3-deltadiscoveryrequest-type-url"><span class="std std-ref">type_url</span></a> set to
<cite>type.googleapis.com/envoy.config.route.v3.VirtualHost</cite>
and <a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-field-service-discovery-v3-deltadiscoveryrequest-resource-names-subscribe"><span class="std std-ref">resource_names_subscribe</span></a>
set to a list of virtual host resource names for which it would like configuration.</p>
<p>If a route for the contents of a host/authority header cannot be resolved, the active stream is
paused while a
<a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-msg-service-discovery-v3-deltadiscoveryrequest"><span class="std std-ref">DeltaDiscoveryRequest</span></a> is sent.
When a <a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-msg-service-discovery-v3-deltadiscoveryresponse"><span class="std std-ref">DeltaDiscoveryResponse</span></a> is received where one of
the <a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-field-service-discovery-v3-resource-aliases"><span class="std std-ref">aliases</span></a> or the
<a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-field-service-discovery-v3-resource-name"><span class="std std-ref">name</span></a> in the response exactly matches the
<a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-field-service-discovery-v3-deltadiscoveryrequest-resource-names-subscribe"><span class="std std-ref">resource_names_subscribe</span></a>
entry from the <a class="reference internal" href="../../../api-v3/service/discovery/v3/discovery.proto.html#envoy-v3-api-msg-service-discovery-v3-deltadiscoveryrequest"><span class="std std-ref">DeltaDiscoveryRequest</span></a>, the route
configuration is updated, the stream is resumed, and processing of the filter chain continues.</p>
<p>Updates to virtual hosts occur in two ways. If a virtual host was originally sent over RDS, then the
virtual host should be updated over RDS. If a virtual host was subscribed to over VHDS, then updates
will take place over VHDS.</p>
<p>When a route configuration entry is updated, if the
<a class="reference internal" href="../../../api-v3/config/route/v3/route.proto.html#envoy-v3-api-field-config-route-v3-routeconfiguration-vhds"><span class="std std-ref">vhds field</span></a> has changed, the virtual host table for
that route configuration is cleared, which will require that all virtual hosts be sent again.</p>
<div class="section" id="compatibility-with-scoped-rds">
<h3>Compatibility with Scoped RDS<a class="headerlink" href="#compatibility-with-scoped-rds" title="Permalink to this headline">¶</a></h3>
<p>VHDS shouldn’t present any compatibility issues with
<a class="reference internal" href="../../../api-v3/config/route/v3/scoped_route.proto.html#envoy-v3-api-msg-config-route-v3-scopedrouteconfiguration"><span class="std std-ref">scoped RDS</span></a>.
Route configuration names can still be used for virtual host matching, but with
scoped RDS configured it would point to a scoped route configuration.</p>
<p>However, it is important to note that using
on-demand <a class="reference internal" href="../../../api-v3/config/route/v3/scoped_route.proto.html#envoy-v3-api-msg-config-route-v3-scopedrouteconfiguration"><span class="std std-ref">scoped RDS</span></a>
and VHDS together will require two on-demand subscriptions per routing scope.</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../overview/xds_api.html#v2-grpc-streaming-endpoints"><span class="std std-ref">v2 API reference</span></a></p></li>
</ul>
</div>
<div class="section" id="statistics">
<h3>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h3>
<p>VHDS has a statistics tree rooted at <em>http.&lt;stat_prefix&gt;.vhds.&lt;virtual_host_name&gt;.</em>.
Any <code class="docutils literal notranslate"><span class="pre">:</span></code> character in the <code class="docutils literal notranslate"><span class="pre">virtual_host_name</span></code> name gets replaced with <code class="docutils literal notranslate"><span class="pre">_</span></code> in the
stats tree. The stats tree contains the following statistics:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>config_reload</p></td>
<td><p>Counter</p></td>
<td><p>Total API fetches that resulted in a config reload due to a different config</p></td>
</tr>
<tr class="row-odd"><td><p>empty_update</p></td>
<td><p>Counter</p></td>
<td><p>Total count of empty updates received</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../http_filters/http_filters.html" class="btn btn-neutral float-right" title="HTTP filters" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rds.html" class="btn btn-neutral float-left" title="Route discovery service (RDS)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>