

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Supported load balancers &mdash; envoy 1.17.0-5c801b documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Priority levels" href="priority.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-5c801b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../listeners/listeners_toc.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../upstream.html">Upstream clusters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="../service_discovery.html">Service discovery</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dns_resolution.html">DNS Resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="../health_checking.html">Health checking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../connection_pooling.html">Connection pooling</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="load_balancing.html">Load Balancing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aggregate_cluster.html">Aggregate Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="../outlier.html">Outlier detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../circuit_breaking.html">Circuit breaking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../upstream_filters.html">Upstream network filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../load_reporting_service.html">Load Reporting Service (LRS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/operations.html">Operations &amp; configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../life_of_a_request.html">Life of a Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_help.html">Getting help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../intro.html">Introduction</a> &raquo;</li>
        
          <li><a href="../../arch_overview.html">Architecture overview</a> &raquo;</li>
        
          <li><a href="../upstream.html">Upstream clusters</a> &raquo;</li>
        
          <li><a href="load_balancing.html">Load Balancing</a> &raquo;</li>
        
      <li>Supported load balancers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/intro/arch_overview/upstream/load_balancing/load_balancers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="supported-load-balancers">
<span id="arch-overview-load-balancing-types"></span><h1>Supported load balancers<a class="headerlink" href="#supported-load-balancers" title="Permalink to this headline">Â¶</a></h1>
<p>When a filter needs to acquire a connection to a host in an upstream cluster, the cluster manager
uses a load balancing policy to determine which host is selected. The load balancing policies are
pluggable and are specified on a per upstream cluster basis in the <a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-msg-config-cluster-v3-cluster"><span class="std std-ref">configuration</span></a>. Note that if no active health checking policy is <a class="reference internal" href="../../../../configuration/upstream/cluster_manager/cluster_hc.html#config-cluster-manager-cluster-hc"><span class="std std-ref">configured</span></a> for a cluster, all upstream cluster members are considered
healthy, unless otherwise specified through
<a class="reference internal" href="../../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-field-config-endpoint-v3-lbendpoint-health-status"><span class="std std-ref">health_status</span></a>.</p>
<div class="section" id="weighted-round-robin">
<span id="arch-overview-load-balancing-types-round-robin"></span><h2>Weighted round robin<a class="headerlink" href="#weighted-round-robin" title="Permalink to this headline">Â¶</a></h2>
<p>This is a simple policy in which each available upstream host is selected in round
robin order. If <a class="reference internal" href="../../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-field-config-endpoint-v3-lbendpoint-load-balancing-weight"><span class="std std-ref">weights</span></a> are assigned to
endpoints in a locality, then a weighted round robin schedule is used, where
higher weighted endpoints will appear more often in the rotation to achieve the
effective weighting.</p>
</div>
<div class="section" id="weighted-least-request">
<span id="arch-overview-load-balancing-types-least-request"></span><h2>Weighted least request<a class="headerlink" href="#weighted-least-request" title="Permalink to this headline">Â¶</a></h2>
<p>The least request load balancer uses different algorithms depending on whether hosts have the
same or different weights.</p>
<ul>
<li><p><em>all weights equal</em>: An O(1) algorithm which selects N random available hosts as specified in the
<a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-msg-config-cluster-v3-cluster-leastrequestlbconfig"><span class="std std-ref">configuration</span></a> (2 by default) and picks the
host which has the fewest active requests (<a class="reference external" href="https://www.eecs.harvard.edu/~michaelm/postscripts/handbook2001.pdf">Mitzenmacher et al.</a> has shown that this
approach is nearly as good as an O(N) full scan). This is also known as P2C (power of two
choices). The P2C load balancer has the property that a host with the highest number of active
requests in the cluster will never receive new requests. It will be allowed to drain until it is
less than or equal to all of the other hosts.</p></li>
<li><p><em>all weights not equal</em>:  If two or more hosts in the cluster have different load balancing
weights, the load balancer shifts into a mode where it uses a weighted round robin schedule in
which weights are dynamically adjusted based on the hostâs request load at the time of selection.</p>
<p>In this case the weights are calculated at the time a host is picked using the following formula:</p>
<p><cite>weight = load_balancing_weight / (active_requests + 1)^active_request_bias</cite>.</p>
<p><a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-leastrequestlbconfig-active-request-bias"><span class="std std-ref">active_request_bias</span></a>
can be configured via runtime and defaults to 1.0. It must be greater than or equal to 0.0.</p>
<p>The larger the active request bias is, the more aggressively active requests will lower the
effective weight.</p>
<p>If <cite>active_request_bias</cite> is set to 0.0, the least request load balancer behaves like the round
robin load balancer and ignores the active request count at the time of picking.</p>
<p>For example, if active_request_bias is 1.0, a host with weight 2 and an active request count of 4
will have an effective weight of 2 / (4 + 1)^1 = 0.4. This algorithm provides good balance at
steady state but may not adapt to load imbalance as quickly. Additionally, unlike P2C, a host will
never truly drain, though it will receive fewer requests over time.</p>
</li>
</ul>
</div>
<div class="section" id="ring-hash">
<span id="arch-overview-load-balancing-types-ring-hash"></span><h2>Ring hash<a class="headerlink" href="#ring-hash" title="Permalink to this headline">Â¶</a></h2>
<p>The ring/modulo hash load balancer implements consistent hashing to upstream hosts. Each host is
mapped onto a circle (the âringâ) by hashing its address; each request is then routed to a host by
hashing some property of the request, and finding the nearest corresponding host clockwise around
the ring. This technique is also commonly known as <a class="reference external" href="https://github.com/RJ/ketama">âKetamaâ</a>
hashing, and like all hash-based load balancers, it is only effective when protocol routing is used
that specifies a value to hash on.</p>
<p>Each host is hashed and placed on the ring some number of times proportional to its weight. For
example, if host A has a weight of 1 and host B has a weight of 2, then there might be three entries
on the ring: one for host A and two for host B. This doesnât actually provide the desired 2:1
partitioning of the circle, however, since the computed hashes could be coincidentally very close to
one another; so it is necessary to multiply the number of hashes per hostâfor example inserting
100 entries on the ring for host A and 200 entries for host Bâto better approximate the desired
distribution. Best practice is to explicitly set
<a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-ringhashlbconfig-minimum-ring-size"><span class="std std-ref">minimum_ring_size</span></a> and
<a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-ringhashlbconfig-maximum-ring-size"><span class="std std-ref">maximum_ring_size</span></a>, and monitor
the <a class="reference internal" href="../../../../configuration/upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats-ring-hash-lb"><span class="std std-ref">min_hashes_per_host and max_hashes_per_host
gauges</span></a> to ensure good distribution. With the
ring partitioned appropriately, the addition or removal of one host from a set of N hosts will
affect only 1/N requests.</p>
<p>When priority based load balancing is in use, the priority level is also chosen by hash, so the
endpoint selected will still be consistent when the set of backends is stable.</p>
</div>
<div class="section" id="maglev">
<span id="arch-overview-load-balancing-types-maglev"></span><h2>Maglev<a class="headerlink" href="#maglev" title="Permalink to this headline">Â¶</a></h2>
<p>The Maglev load balancer implements consistent hashing to upstream hosts. It uses the algorithm
described in section 3.4 of <a class="reference external" href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/44824.pdf">this paper</a>
with a fixed table size of 65537 (see section 5.3 of the same paper). Maglev can be used as a drop
in replacement for the <a class="reference internal" href="#arch-overview-load-balancing-types-ring-hash"><span class="std std-ref">ring hash load balancer</span></a>
any place in which consistent hashing is desired. Like the ring hash load balancer, a consistent
hashing load balancer is only effective when protocol routing is used that specifies a value to
hash on.</p>
<p>The table construction algorithm places each host in the table some number of times proportional
to its weight, until the table is completely filled. For example, if host A has a weight of 1 and
host B has a weight of 2, then host A will have 21,846 entries and host B will have 43,691 entries
(totaling 65,537 entries). The algorithm attempts to place each host in the table at least once,
regardless of the configured host and locality weights, so in some extreme cases the actual
proportions may differ from the configured weights. For example, if the total number of hosts is
larger than the fixed table size, then some hosts will get 1 entry each and the rest will get 0,
regardless of weight. Best practice is to monitor the <a class="reference internal" href="../../../../configuration/upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats-maglev-lb"><span class="std std-ref">min_entries_per_host and
max_entries_per_host gauges</span></a> to ensure no hosts
are underrepresented or missing.</p>
<p>In general, when compared to the ring hash (âketamaâ) algorithm, Maglev has substantially faster
table lookup build times as well as host selection times (approximately 10x and 5x respectively
when using a large ring size of 256K entries). The downside of Maglev is that it is not as stable
as ring hash. More keys will move position when hosts are removed (simulations show approximately
double the keys will move). With that said, for many applications including Redis, Maglev is very
likely a superior drop in replacement for ring hash. The advanced reader can use
<a class="reference external" href="https://github.com/envoyproxy/envoy/blob/5c801b25cae04f06bf48248c90e87d623d7a6283//test/common/upstream/load_balancer_benchmark.cc">this benchmark</a> to compare ring hash
versus Maglev with different parameters.</p>
</div>
<div class="section" id="random">
<span id="arch-overview-load-balancing-types-random"></span><h2>Random<a class="headerlink" href="#random" title="Permalink to this headline">Â¶</a></h2>
<p>The random load balancer selects a random available host. The random load balancer generally performs
better than round robin if no health checking policy is configured. Random selection avoids bias
towards the host in the set that comes after a failed host.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="priority.html" class="btn btn-neutral float-right" title="Priority levels" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="overview.html" class="btn btn-neutral float-left" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>