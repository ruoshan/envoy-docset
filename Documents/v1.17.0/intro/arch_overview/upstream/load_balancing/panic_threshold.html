

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Panic threshold &mdash; envoy 1.17.0-5c801b documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Original destination" href="original_dst.html" />
    <link rel="prev" title="Overprovisioning Factor" href="overprovisioning.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-5c801b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../listeners/listeners_toc.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../upstream.html">Upstream clusters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="../service_discovery.html">Service discovery</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dns_resolution.html">DNS Resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="../health_checking.html">Health checking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../connection_pooling.html">Connection pooling</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="load_balancing.html">Load Balancing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aggregate_cluster.html">Aggregate Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="../outlier.html">Outlier detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../circuit_breaking.html">Circuit breaking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../upstream_filters.html">Upstream network filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../load_reporting_service.html">Load Reporting Service (LRS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/operations.html">Operations &amp; configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../life_of_a_request.html">Life of a Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_help.html">Getting help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../intro.html">Introduction</a> &raquo;</li>
        
          <li><a href="../../arch_overview.html">Architecture overview</a> &raquo;</li>
        
          <li><a href="../upstream.html">Upstream clusters</a> &raquo;</li>
        
          <li><a href="load_balancing.html">Load Balancing</a> &raquo;</li>
        
      <li>Panic threshold</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/intro/arch_overview/upstream/load_balancing/panic_threshold.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="panic-threshold">
<span id="arch-overview-load-balancing-panic-threshold"></span><h1>Panic threshold<a class="headerlink" href="#panic-threshold" title="Permalink to this headline">Â¶</a></h1>
<p>During load balancing, Envoy will generally only consider available (healthy or degraded) hosts in
an upstream cluster. However, if the percentage of available hosts in the cluster becomes too low,
Envoy will disregard health status and balance either amongst all hosts or no hosts. This is known
as the <em>panic threshold</em>. The default panic threshold is 50%. This is
<a class="reference internal" href="../../../../configuration/upstream/cluster_manager/cluster_runtime.html#config-cluster-manager-cluster-runtime"><span class="std std-ref">configurable</span></a> via runtime as well as in the
<a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-commonlbconfig-healthy-panic-threshold"><span class="std std-ref">cluster configuration</span></a>.
The panic threshold is used to avoid a situation in which host failures cascade throughout the
cluster as load increases.</p>
<p>There are two modes Envoy can choose from when in a panic state: traffic will either be sent to all
hosts, or will be sent to no hosts (and therefore will always fail). This is configured in the
<a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-commonlbconfig-zoneawarelbconfig-fail-traffic-on-panic"><span class="std std-ref">cluster configuration</span></a>.
Choosing to fail traffic during panic scenarios can help avoid overwhelming potentially failing
upstream services, as it will reduce the load on the upstream service before all hosts have been
determined to be unhealthy. However, it eliminates the possibility of _some_ requests succeeding
even when many or all hosts in a cluster are unhealthy. This may be a good tradeoff to make if a
given service is observed to fail in an all-or-nothing pattern, as it will more quickly cut off
requests to the cluster. Conversely, if a cluster typically continues to successfully service _some_
requests even when degraded, enabling this option is probably unhelpful.</p>
<p>Panic thresholds work in conjunction with priorities. If the number of available hosts in a given
priority goes down, Envoy will try to shift some traffic to lower priorities. If it succeeds in
finding enough available hosts in lower priorities, Envoy will disregard panic thresholds. In
mathematical terms, if normalized total availability across all priority levels is 100%, Envoy
disregards panic thresholds and continues to distribute traffic load across priorities according to
the algorithm described <a class="reference internal" href="priority.html#arch-overview-load-balancing-priority-levels"><span class="std std-ref">here</span></a>.
However, when normalized total availability drops below 100%, Envoy assumes that there are not enough
available hosts across all priority levels. It continues to distribute traffic load across priorities,
but if a given priority levelâs availability is below the panic threshold, traffic will go to all
(or no) hosts in that priority level regardless of their availability.</p>
<p>The following examples explain the relationship between normalized total availability and panic threshold.
It is assumed that the default value of 50% is used for the panic threshold.</p>
<p>Assume a simple set-up with 2 priority levels, P=1 100% healthy. In this scenario normalized total
health is always 100%, P=0 never enters panic mode, and Envoy is able to shift as much traffic as
necessary to P=1.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 15%" />
<col style="width: 18%" />
<col style="width: 15%" />
<col style="width: 18%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>P=0 healthy
endpoints</p></th>
<th class="head"><dl class="simple">
<dt>Traffic</dt><dd><p>to P=0</p>
</dd>
</dl>
</th>
<th class="head"><p>P=0 in panic</p></th>
<th class="head"><p>Traffic
to P=1</p></th>
<th class="head"><p>P=1 in panic</p></th>
<th class="head"><p>normalized
total health</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>72%</p></td>
<td><p>100%</p></td>
<td><p>NO</p></td>
<td><p>0%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-odd"><td><p>71%</p></td>
<td><p>99%</p></td>
<td><p>NO</p></td>
<td><p>1%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-even"><td><p>50%</p></td>
<td><p>70%</p></td>
<td><p>NO</p></td>
<td><p>30%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-odd"><td><p>25%</p></td>
<td><p>35%</p></td>
<td><p>NO</p></td>
<td><p>65%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-even"><td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
</tbody>
</table>
<p>If P=1 becomes unhealthy, panic threshold continues to be disregarded until the sum of the health
P=0 + P=1 goes below 100%. At this point Envoy starts checking panic threshold value for each
priority.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 11%" />
<col style="width: 16%" />
<col style="width: 11%" />
<col style="width: 16%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>P=0 healthy
endpoints</p></th>
<th class="head"><p>P=1 healthy
endpoints</p></th>
<th class="head"><p>Traffic
to P=0</p></th>
<th class="head"><p>P=0 in panic</p></th>
<th class="head"><p>Traffic
to P=1</p></th>
<th class="head"><p>P=1 in panic</p></th>
<th class="head"><p>normalized
total health</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>72%</p></td>
<td><p>72%</p></td>
<td><p>100%</p></td>
<td><p>NO</p></td>
<td><p>0%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-odd"><td><p>71%</p></td>
<td><p>71%</p></td>
<td><p>99%</p></td>
<td><p>NO</p></td>
<td><p>1%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-even"><td><p>50%</p></td>
<td><p>60%</p></td>
<td><p>70%</p></td>
<td><p>NO</p></td>
<td><p>30%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-odd"><td><p>25%</p></td>
<td><p>100%</p></td>
<td><p>35%</p></td>
<td><p>NO</p></td>
<td><p>65%</p></td>
<td><p>NO</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-even"><td><p>25%</p></td>
<td><p>25%</p></td>
<td><p>50%</p></td>
<td><p>YES</p></td>
<td><p>50%</p></td>
<td><p>YES</p></td>
<td><p>70%</p></td>
</tr>
<tr class="row-odd"><td><p>5%</p></td>
<td><p>65%</p></td>
<td><p>7%</p></td>
<td><p>YES</p></td>
<td><p>93%</p></td>
<td><p>NO</p></td>
<td><p>98%</p></td>
</tr>
</tbody>
</table>
<p>Panic mode can be disabled by setting the panic threshold to 0%.</p>
<p>Load distribution is calculated as described above as long as there are priority levels not in panic mode.
When all priority levels enter the panic mode, load calculation algorithm changes.
In this case each priority level receives traffic relative to the number of hosts in that priority level
in relation to the number of hosts in all priority levels.
For example, if there are 2 priorities P=0 and P=1 and each of them consists of 5 hosts, each level will
receive 50% of the traffic.
If there are 2 hosts in priority P=0 and 8 hosts in priority P=1, priority P=0 will receive 20% of the
traffic and priority P=1 will receive 80% of the traffic.</p>
<p>However, if the panic threshold is 0% for any priority, that priority will never enter panic mode.
In this case if all hosts are unhealthy, Envoy will fail to select a host and will instead immediately
return error responses with â503 - no healthy upstreamâ.</p>
<p>Note that panic thresholds can be configured <em>per-priority</em>.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="original_dst.html" class="btn btn-neutral float-right" title="Original destination" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="overprovisioning.html" class="btn btn-neutral float-left" title="Overprovisioning Factor" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>