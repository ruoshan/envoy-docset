

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How do I configure flow control? &mdash; envoy 1.17.0-5c801b documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="How do I configure timeouts?" href="timeouts.html" />
    <link rel="prev" title="How do I configure Zipkin tracing?" href="zipkin_tracing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-5c801b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../overview.html">FAQ</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview.html#build">Build</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#api">API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#debugging">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#performance">Performance</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../overview.html#configuration">Configuration</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="edge.html">How do I configure Envoy as an edge proxy?</a></li>
<li class="toctree-l3"><a class="reference internal" href="level_two.html">How do I configure Envoy as a level two proxy?</a></li>
<li class="toctree-l3"><a class="reference internal" href="sni.html">How do I configure SNI for listeners?</a></li>
<li class="toctree-l3"><a class="reference internal" href="sni.html#how-do-i-configure-sni-for-clusters">How do I configure SNI for clusters?</a></li>
<li class="toctree-l3"><a class="reference internal" href="zone_aware_routing.html">How do I configure zone aware routing?</a></li>
<li class="toctree-l3"><a class="reference internal" href="zipkin_tracing.html">How do I configure Zipkin tracing?</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">How do I configure flow control?</a></li>
<li class="toctree-l3"><a class="reference internal" href="timeouts.html">How do I configure timeouts?</a></li>
<li class="toctree-l3"><a class="reference internal" href="deprecation.html">How are configuration deprecations handled?</a></li>
<li class="toctree-l3"><a class="reference internal" href="resource_limits.html">How does Envoy prevent file descriptor exhaustion?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#load-balancing">Load balancing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#extensions">Extensions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../overview.html">FAQ</a> &raquo;</li>
        
      <li>How do I configure flow control?</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/faq/configuration/flow_control.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-do-i-configure-flow-control">
<span id="faq-flow-control"></span><h1>How do I configure flow control?<a class="headerlink" href="#how-do-i-configure-flow-control" title="Permalink to this headline">Â¶</a></h1>
<p>Flow control may cause problems where Envoy is using non-streaming L7 filters, and request or
response bodies exceed the L7 buffer limits. For requests where the body must be buffered and
exceeds the configured limits, Envoy will serve a 413 to the user and increment the
<a class="reference internal" href="../../configuration/http/http_conn_man/stats.html#config-http-conn-man-stats"><span class="std std-ref">downstream_rq_too_large</span></a> metric. On the response path if the
response body must be buffered and exceeds the limit, Envoy will increment the
<a class="reference internal" href="../../configuration/http/http_conn_man/stats.html#config-http-conn-man-stats"><span class="std std-ref">rs_too_large</span></a> metric and either disconnect mid-response
(if headers have already been sent downstream) or send a 500 response.</p>
<p>There are three knobs for configuring Envoy flow control:
<a class="reference internal" href="../../api-v3/config/listener/v3/listener.proto.html#envoy-v3-api-field-config-listener-v3-listener-per-connection-buffer-limit-bytes"><span class="std std-ref">listener limits</span></a>,
<a class="reference internal" href="../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-per-connection-buffer-limit-bytes"><span class="std std-ref">cluster limits</span></a> and
<a class="reference internal" href="../../api-v3/config/core/v3/protocol.proto.html#envoy-v3-api-field-config-core-v3-http2protocoloptions-initial-connection-window-size"><span class="std std-ref">http2 stream limits</span></a></p>
<p>The listener limits apply to how much raw data will be read per read() call from
downstream, as well as how much data may be buffered in userspace between Envoy
and downstream.</p>
<p>The listener limits are also propogated to the HttpConnectionManager, and applied on a per-stream
basis to HTTP/1.1 L7 buffers described below. As such they limit the size of HTTP/1 requests and
response bodies that can be buffered. For HTTP/2, as many streams can be multiplexed over one TCP
connection, the L7 and L4 buffer limits can be tuned separately, and the configuration option
<a class="reference internal" href="../../api-v3/config/core/v3/protocol.proto.html#envoy-v3-api-field-config-core-v3-http2protocoloptions-initial-connection-window-size"><span class="std std-ref">http2 stream limits</span></a>
is applied to all of the L7 buffers. Note that for both HTTP/1 and
HTTP/2 Envoy can and will proxy arbitrarily large bodies on routes where all L7 filters are
streaming, but many filters such as the transcoder or buffer filters require the full HTTP body to
be buffered, so limit the request and response size based on the listener limit.</p>
<p>The cluster limits affect how much raw data will be read per read() call from upstream, as
well as how much data may be buffered in userspace between Envoy and upstream.</p>
<p>The following code block shows how to adjust all three fields mentioned above, though generally
the only one which needs to be amended is the listener
<a class="reference internal" href="../../api-v3/config/listener/v3/listener.proto.html#envoy-v3-api-field-config-listener-v3-listener-per-connection-buffer-limit-bytes"><span class="std std-ref">per_connection_buffer_limit_bytes</span></a></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">static_resources</span><span class="p">:</span>
  <span class="nt">listeners</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="nt">address</span><span class="p">:</span>
      <span class="nt">socket_address</span><span class="p">:</span>
        <span class="nt">address</span><span class="p">:</span> <span class="s">&#39;::1&#39;</span>
        <span class="nt">portValue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="nt">filter_chains</span><span class="p">:</span>
      <span class="nt">filters</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.network.http_connection_manager</span>
        <span class="nt">typed_config</span><span class="p">:</span>
          <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
          <span class="nt">http2_protocol_options</span><span class="p">:</span>
            <span class="nt">initial_stream_window_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
          <span class="nt">route_config</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
          <span class="nt">codec_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP2</span>
          <span class="nt">http_filters</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
          <span class="nt">stat_prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config_test</span>
    <span class="nt">per_connection_buffer_limit_bytes</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1024</span>
  <span class="nt">clusters</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster_0</span>
    <span class="nt">connect_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5s</span>
    <span class="nt">per_connection_buffer_limit_bytes</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1024</span>
    <span class="nt">load_assignment</span><span class="p">:</span>
      <span class="nt">cluster_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">some_service</span>
      <span class="nt">endpoints</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">lb_endpoints</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">endpoint</span><span class="p">:</span>
              <span class="nt">address</span><span class="p">:</span>
                <span class="nt">socket_address</span><span class="p">:</span>
                  <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">::1</span>
                  <span class="nt">port_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">46685</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="timeouts.html" class="btn btn-neutral float-right" title="How do I configure timeouts?" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="zipkin_tracing.html" class="btn btn-neutral float-left" title="How do I configure Zipkin tracing?" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>