

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CSRF &mdash; envoy tag-v1.11.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Dynamic forward proxy" href="dynamic_forward_proxy_filter.html" />
    <link rel="prev" title="CORS" href="cors_filter.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> envoy
          

          
          </a>

          
            
            
              <div class="version">
                tag-v1.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/install.html">Building and installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview/v2_overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../listener_filters/listener_filters.html">Listener filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network_filters/network_filters.html">Network filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">CSRF</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#runtime">Runtime</a></li>
<li class="toctree-l4"><a class="reference internal" href="#statistics">Statistics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l3"><a class="reference internal" href="gzip_filter.html">Gzip</a></li>
<li class="toctree-l3"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l3"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l3"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="lua_filter.html">Lua</a></li>
<li class="toctree-l3"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l3"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="router_filter.html">Router</a></li>
<li class="toctree-l3"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l3"><a class="reference internal" href="tap_filter.html">Tap</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../thrift_filters/thrift_filters.html">Thrift filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dubbo_filters/dubbo_filters.html">Dubbo filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster_manager/cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../health_checkers/health_checkers.html">Health checkers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../access_log.html">Access logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate_limit.html">Rate limit service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runtime.html">Runtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../statistics.html">Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/router_check.html">Route table check tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overload_manager/overload_manager.html">Overload manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../secret.html">Secret discovery service (SDS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../well_known_dynamic_metadata.html">Well Known Dynamic Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="http_filters.html">HTTP filters</a> &raquo;</li>
        
      <li>CSRF</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/configuration/http_filters/csrf_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="csrf">
<span id="config-http-filters-csrf"></span><h1>CSRF<a class="headerlink" href="#csrf" title="Permalink to this headline">¶</a></h1>
<p>This is a filter which prevents Cross-Site Request Forgery based on a route or virtual host settings.
At it’s simplest, CSRF is an attack that occurs when a malicious third-party
exploits a vulnerability that allows them to submit an undesired request on the
user’s behalf.</p>
<p>A real-life example is cited in section 1 of <a class="reference external" href="https://seclab.stanford.edu/websec/csrf/csrf.pdf">Robust Defenses for Cross-Site Request Forgery</a>:</p>
<blockquote>
<div>“For example, in late 2007 [42], Gmail had a CSRF vulnerability. When a Gmail user visited
a malicious site, the malicious site could generate a request to Gmail that Gmail treated
as part of its ongoing session with the victim. In November 2007, a web attacker exploited
this CSRF vulnerability to inject an email filter into David Airey’s Gmail account [1].”</div></blockquote>
<p>There are many ways to mitigate CSRF, some of which have been outlined in the
<a class="reference external" href="https://github.com/OWASP/CheatSheetSeries/blob/5a1044e38778b42a19c6adbb4dfef7a0fb071099/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md">OWASP Prevention Cheat Sheet</a>.
This filter employs a stateless mitigation pattern known as origin verification.</p>
<p>This pattern relies on two pieces of information used in determining if
a request originated from the same host.
* The origin that caused the user agent to issue the request (source origin).
* The origin that the request is going to (target origin).</p>
<p>When the filter is evaluating a request, it ensures both pieces of information are present
and compares their values. If the source origin is missing or the origins do not match
the request is rejected. The exception to this being if the source origin has been
added to the policy as valid.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Due to differing functionality between browsers this filter will determine
a request’s source origin from the Origin header. If that is not present it will
fall back to the host and port value from the requests Referer header.</p>
</div>
</div></blockquote>
<p>For more information on CSRF please refer to the pages below.</p>
<ul>
<li><p class="first"><a class="reference external" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29">https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29</a></p>
</li>
<li><p class="first"><a class="reference external" href="https://seclab.stanford.edu/websec/csrf/csrf.pdf">https://seclab.stanford.edu/websec/csrf/csrf.pdf</a></p>
</li>
<li><p class="first"><a class="reference internal" href="../../api-v2/config/filter/http/csrf/v2/csrf.proto.html#envoy-api-msg-config-filter-http-csrf-v2-csrfpolicy"><span class="std std-ref">v2 API reference</span></a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This filter should be configured with the name <em>envoy.csrf</em>.</p>
</div>
</li>
</ul>
<div class="section" id="configuration">
<span id="csrf-configuration"></span><h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>The CSRF filter supports the ability to extend the source origins it will consider
valid. The reason it is able to do this while still mitigating cross-site request
forgery attempts is because the target origin has already been reached by the time
front-envoy is applying the filter. This means that while endpoints may support
cross-origin requests they are still protected from malicious third-parties who
have not been whitelisted.</p>
<p>It’s important to note that requests should generally originate from the same
origin as the target but there are use cases where that may not be possible.
For example, if you are hosting a static site on a third-party vendor but need
to make requests for tracking purposes.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Additional origins can be either an exact string, regex pattern, prefix string,
or suffix string. It’s advised to be cautious when adding regex, prefix, or suffix
origins since an ambiguous origin can pose a security vulnerability.</p>
</div>
</div>
<div class="section" id="runtime">
<span id="csrf-runtime"></span><h2>Runtime<a class="headerlink" href="#runtime" title="Permalink to this headline">¶</a></h2>
<p>The CSRF filter supports the following RuntimeFractionalPercent settings:</p>
<dl class="docutils">
<dt>filter_enabled</dt>
<dd><p class="first">The % of requests for which the filter is enabled. The default is
100/<a class="reference internal" href="../../api-v2/type/percent.proto.html#envoy-api-enum-type-fractionalpercent-denominatortype"><span class="std std-ref">HUNDRED</span></a>.</p>
<p class="last">To utilize runtime to enabled/disable the CSRF filter set the
<a class="reference internal" href="../../api-v2/api/v2/core/base.proto.html#envoy-api-msg-core-runtimefractionalpercent"><span class="std std-ref">runtime_key</span></a>
value of the <a class="reference internal" href="../../api-v2/config/filter/http/csrf/v2/csrf.proto.html#envoy-api-msg-config-filter-http-csrf-v2-csrfpolicy"><span class="std std-ref">filter_enabled</span></a>
field.</p>
</dd>
<dt>shadow_enabled</dt>
<dd><p class="first">The % of requests for which the filter is enabled in shadow only mode. Default is 0.
If present, this will evaluate a request’s <em>Origin</em> and <em>Destination</em> to determine
if the request is valid but will not enforce any policies.</p>
<p class="last">To utilize runtime to enabled/disable the CSRF filter’s shadow mode set the
<a class="reference internal" href="../../api-v2/api/v2/core/base.proto.html#envoy-api-msg-core-runtimefractionalpercent"><span class="std std-ref">runtime_key</span></a>
value of the <a class="reference internal" href="../../api-v2/config/filter/http/csrf/v2/csrf.proto.html#envoy-api-msg-config-filter-http-csrf-v2-csrfpolicy"><span class="std std-ref">shadow_enabled</span></a>
field.</p>
</dd>
</dl>
<p>To determine if the filter and/or shadow mode are enabled you can check the runtime
values via the admin panel at <a class="reference internal" href="../../operations/admin.html#get--runtime" title="GET /runtime"><code class="xref http http-get docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/runtime</span></code></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If both <code class="docutils literal notranslate"><span class="pre">filter_enabled</span></code> and <code class="docutils literal notranslate"><span class="pre">shadow_enabled</span></code> are on, the <code class="docutils literal notranslate"><span class="pre">filter_enabled</span></code>
flag will take precedence.</p>
</div>
</div>
<div class="section" id="statistics">
<span id="csrf-statistics"></span><h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h2>
<p>The CSRF filter outputs statistics in the &lt;stat_prefix&gt;.csrf.* namespace.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>missing_source_origin</td>
<td>Counter</td>
<td>Number of requests that are missing a source origin header.</td>
</tr>
<tr class="row-odd"><td>request_invalid</td>
<td>Counter</td>
<td>Number of requests whose source and target origins do not match.</td>
</tr>
<tr class="row-even"><td>request_valid</td>
<td>Counter</td>
<td>Number of requests whose source and target origins match.</td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dynamic_forward_proxy_filter.html" class="btn btn-neutral float-right" title="Dynamic forward proxy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cors_filter.html" class="btn btn-neutral" title="CORS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2019, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>