

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tap &mdash; envoy tag-v1.11.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Thrift filters" href="../thrift_filters/thrift_filters.html" />
    <link rel="prev" title="Squash" href="squash_filter.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> envoy
          

          
          </a>

          
            
            
              <div class="version">
                tag-v1.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/install.html">Building and installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview/v2_overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../listener_filters/listener_filters.html">Listener filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network_filters/network_filters.html">Network filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l3"><a class="reference internal" href="csrf_filter.html">CSRF</a></li>
<li class="toctree-l3"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l3"><a class="reference internal" href="gzip_filter.html">Gzip</a></li>
<li class="toctree-l3"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l3"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l3"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="lua_filter.html">Lua</a></li>
<li class="toctree-l3"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l3"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="router_filter.html">Router</a></li>
<li class="toctree-l3"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tap</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example-configuration">Example configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#admin-handler">Admin handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-format">Output format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#buffered-body-limits">Buffered body limits</a></li>
<li class="toctree-l4"><a class="reference internal" href="#streaming-matching">Streaming matching</a></li>
<li class="toctree-l4"><a class="reference internal" href="#statistics">Statistics</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../thrift_filters/thrift_filters.html">Thrift filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dubbo_filters/dubbo_filters.html">Dubbo filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster_manager/cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../health_checkers/health_checkers.html">Health checkers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../access_log.html">Access logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate_limit.html">Rate limit service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runtime.html">Runtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../statistics.html">Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/router_check.html">Route table check tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overload_manager/overload_manager.html">Overload manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../secret.html">Secret discovery service (SDS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../well_known_dynamic_metadata.html">Well Known Dynamic Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="http_filters.html">HTTP filters</a> &raquo;</li>
        
      <li>Tap</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/configuration/http_filters/tap_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tap">
<span id="config-http-filters-tap"></span><h1>Tap<a class="headerlink" href="#tap" title="Permalink to this headline">Â¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="../../api-v2/config/filter/http/tap/v2alpha/tap.proto.html#envoy-api-msg-config-filter-http-tap-v2alpha-tap"><span class="std std-ref">v2 API reference</span></a></li>
<li>This filter should be configured with the name <em>envoy.filters.http.tap</em>.</li>
</ul>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">The tap filter is experimental and is currently under active development. There is currently a
very limited set of match conditions, output configuration, output sinks, etc. Capabilities will
be expanded over time and the configuration structures are likely to change.</p>
</div>
<p>The HTTP tap filter is used to interpose on and record HTTP traffic. At a high level, the
configuration is composed of two pieces:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-msg-service-tap-v2alpha-matchpredicate"><span class="std std-ref">Match configuration</span></a>: a list of
conditions under which the filter will match an HTTP request and begin a tap session.</li>
<li><a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-msg-service-tap-v2alpha-outputconfig"><span class="std std-ref">Output configuration</span></a>: a list of output
sinks that the filter will write the matched and tapped data to.</li>
</ol>
<p>Each of these concepts will be covered incrementally over the course of several example
configurations in the following section.</p>
<div class="section" id="example-configuration">
<h2>Example configuration<a class="headerlink" href="#example-configuration" title="Permalink to this headline">Â¶</a></h2>
<p>Example filter configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.tap</span>
<span class="l l-Scalar l-Scalar-Plain">config</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">common_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">admin_config</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">config_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_config_id</span>
</pre></div>
</div>
<p>The previous snippet configures the filter for control via the <a class="reference internal" href="../../operations/admin.html#post--tap" title="POST /tap"><code class="xref http http-post docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/tap</span></code></a> admin handler.
See the following section for more details.</p>
</div>
<div class="section" id="admin-handler">
<span id="config-http-filters-tap-admin-handler"></span><h2>Admin handler<a class="headerlink" href="#admin-handler" title="Permalink to this headline">Â¶</a></h2>
<p>When the HTTP filter specifies an <a class="reference internal" href="../../api-v2/config/common/tap/v2alpha/common.proto.html#envoy-api-msg-config-common-tap-v2alpha-adminconfig"><span class="std std-ref">admin_config</span></a>, it is configured for admin control and
the <a class="reference internal" href="../../operations/admin.html#post--tap" title="POST /tap"><code class="xref http http-post docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/tap</span></code></a> admin handler will be installed. The admin handler can be used for live
tapping and debugging of HTTP traffic. It works as follows:</p>
<ol class="arabic simple">
<li>A POST request is used to provide a valid tap configuration. The POST request body can be either
the JSON or YAML representation of the <a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-msg-service-tap-v2alpha-tapconfig"><span class="std std-ref">TapConfig</span></a> message.</li>
<li>If the POST request is accepted, Envoy will stream <a class="reference internal" href="../../api-v2/data/tap/v2alpha/http.proto.html#envoy-api-msg-data-tap-v2alpha-httpbufferedtrace"><span class="std std-ref">HttpBufferedTrace</span></a> messages (serialized to JSON) until the admin
request is terminated.</li>
</ol>
<p>An example POST body:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">config_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_config_id</span>
<span class="l l-Scalar l-Scalar-Plain">tap_config</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">match_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">and_match</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http_request_headers_match</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
              <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">foo</span>
                <span class="l l-Scalar l-Scalar-Plain">exact_match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http_response_headers_match</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
              <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
                <span class="l l-Scalar l-Scalar-Plain">exact_match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">baz</span>
  <span class="l l-Scalar l-Scalar-Plain">output_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">sinks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">streaming_admin</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>The preceding configuration instructs the tap filter to match any HTTP requests in which a request
header <code class="docutils literal notranslate"><span class="pre">foo:</span> <span class="pre">bar</span></code> is present AND a response header <code class="docutils literal notranslate"><span class="pre">bar:</span> <span class="pre">baz</span></code> is present. If both of these
conditions are met, the request will be tapped and streamed out the admin endpoint.</p>
<p>Another example POST body:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">config_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_config_id</span>
<span class="l l-Scalar l-Scalar-Plain">tap_config</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">match_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">or_match</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http_request_headers_match</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
              <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">foo</span>
                <span class="l l-Scalar l-Scalar-Plain">exact_match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http_response_headers_match</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
              <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
                <span class="l l-Scalar l-Scalar-Plain">exact_match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">baz</span>
  <span class="l l-Scalar l-Scalar-Plain">output_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">sinks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">streaming_admin</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>The preceding configuration instructs the tap filter to match any HTTP requests in which a request
header <code class="docutils literal notranslate"><span class="pre">foo:</span> <span class="pre">bar</span></code> is present OR a response header <code class="docutils literal notranslate"><span class="pre">bar:</span> <span class="pre">baz</span></code> is present. If either of these
conditions are met, the request will be tapped and streamed out the admin endpoint.</p>
<p>Another example POST body:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">config_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_config_id</span>
<span class="l l-Scalar l-Scalar-Plain">tap_config</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">match_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">any_match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">output_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">sinks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">streaming_admin</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>The preceding configuration instructs the tap filter to match any HTTP requests. All requests will
be tapped and streamed out the admin endpoint.</p>
</div>
<div class="section" id="output-format">
<h2>Output format<a class="headerlink" href="#output-format" title="Permalink to this headline">Â¶</a></h2>
<p>Each output sink has an associated <a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-enum-service-tap-v2alpha-outputsink-format"><span class="std std-ref">format</span></a>. The default format is
<a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-enum-value-service-tap-v2alpha-outputsink-format-json-body-as-bytes"><span class="std std-ref">JSON_BODY_AS_BYTES</span></a>. This format is
easy to read JSON, but has the downside that body data is base64 encoded. In the case that the tap
is known to be on human readable data, the <a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-enum-value-service-tap-v2alpha-outputsink-format-json-body-as-string"><span class="std std-ref">JSON_BODY_AS_STRING</span></a> format may be
more user friendly. See the reference documentation for more information on other available formats.</p>
<p>An example of a streaming admin tap configuration that uses the <a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-enum-value-service-tap-v2alpha-outputsink-format-json-body-as-string"><span class="std std-ref">JSON_BODY_AS_STRING</span></a> format:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">config_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_config_id</span>
<span class="l l-Scalar l-Scalar-Plain">tap_config</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">match_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">any_match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">output_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">sinks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">JSON_BODY_AS_STRING</span>
        <span class="l l-Scalar l-Scalar-Plain">streaming_admin</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
</pre></div>
</div>
</div>
<div class="section" id="buffered-body-limits">
<h2>Buffered body limits<a class="headerlink" href="#buffered-body-limits" title="Permalink to this headline">Â¶</a></h2>
<p>For buffered taps, Envoy will limit the amount of body data that is tapped to avoid OOM situations.
The default limit is 1KiB for both received (request) and transmitted (response) data. This is
configurable via the <a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-field-service-tap-v2alpha-outputconfig-max-buffered-rx-bytes"><span class="std std-ref">max_buffered_rx_bytes</span></a> and
<a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-field-service-tap-v2alpha-outputconfig-max-buffered-tx-bytes"><span class="std std-ref">max_buffered_tx_bytes</span></a> settings.</p>
</div>
<div class="section" id="streaming-matching">
<span id="config-http-filters-tap-streaming"></span><h2>Streaming matching<a class="headerlink" href="#streaming-matching" title="Permalink to this headline">Â¶</a></h2>
<p>The tap filter supports âstreaming matching.â This means that instead of waiting until the end of
the request/response sequence, the filter will match incrementally as the request proceeds. I.e.,
first the request headers will be matched, then the request body if present, then the request
trailers if present, then the response headers if present, etc.</p>
<p>The filter additionally supports optional streamed output which is governed by the <a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-field-service-tap-v2alpha-outputconfig-streaming"><span class="std std-ref">streaming</span></a> setting. If this setting is false
(the default), Envoy will emit <a class="reference internal" href="../../api-v2/data/tap/v2alpha/http.proto.html#envoy-api-msg-data-tap-v2alpha-httpbufferedtrace"><span class="std std-ref">fully buffered traces</span></a>. Users are likely to find this format easier
to interact with for simple cases.</p>
<p>In cases where fully buffered traces are not practical (e.g., very large request and responses,
long lived streaming APIs, etc.), the streaming setting can be set to true, and Envoy will emit
multiple <a class="reference internal" href="../../api-v2/data/tap/v2alpha/http.proto.html#envoy-api-msg-data-tap-v2alpha-httpstreamedtracesegment"><span class="std std-ref">streamed trace segments</span></a> for
each tap. In this case, it is required that post-processing is performed to stitch all of the trace
segments back together into a usable form. Also note that binary protobuf is not a self-delimiting
format. If binary protobuf output is desired, the <a class="reference internal" href="../../api-v2/service/tap/v2alpha/common.proto.html#envoy-api-enum-value-service-tap-v2alpha-outputsink-format-proto-binary-length-delimited"><span class="std std-ref">PROTO_BINARY_LENGTH_DELIMITED</span></a> output
format should be used.</p>
<p>An static filter configuration to enable streaming output looks like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.tap</span>
<span class="l l-Scalar l-Scalar-Plain">config</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">common_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">static_config</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">match_config</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">http_response_headers_match</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
              <span class="l l-Scalar l-Scalar-Plain">exact_match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">baz</span>
      <span class="l l-Scalar l-Scalar-Plain">output_config</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">streaming</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">sinks</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PROTO_BINARY_LENGTH_DELIMITED</span>
            <span class="l l-Scalar l-Scalar-Plain">file_per_tap</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">path_prefix</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/</span>
</pre></div>
</div>
<p>The previous configuration will match response headers, and as such will buffer request headers,
body, and trailers until a match can be determined (buffered data limits still apply as described
in the previous section). If a match is determined, buffered data will be flushed in individual
trace segments and then the rest of the tap will be streamed as data arrives. The messages output
might look like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">http_streamed_trace_segment</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">trace_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">request_headers</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">a</span>
        <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">b</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">http_streamed_trace_segment</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">trace_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">request_body_chunk</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">as_bytes</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">aGVsbG8=</span>
</pre></div>
</div>
<p>Etc.</p>
</div>
<div class="section" id="statistics">
<h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">Â¶</a></h2>
<p>The tap filter outputs statistics in the <em>http.&lt;stat_prefix&gt;.tap.</em> namespace. The <a class="reference internal" href="../../api-v2/config/filter/network/http_connection_manager/v2/http_connection_manager.proto.html#envoy-api-field-config-filter-network-http-connection-manager-v2-httpconnectionmanager-stat-prefix"><span class="std std-ref">stat prefix</span></a>
comes from the owning HTTP connection manager.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>rq_tapped</td>
<td>Counter</td>
<td>Total requests that matched and were tapped</td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../thrift_filters/thrift_filters.html" class="btn btn-neutral float-right" title="Thrift filters" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="squash_filter.html" class="btn btn-neutral" title="Squash" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2019, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>