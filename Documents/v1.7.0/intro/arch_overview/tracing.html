

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tracing &mdash; envoy tag-v1.7.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="TCP proxy" href="tcp_proxy.html" />
    <link rel="prev" title="Runtime configuration" href="runtime.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> envoy
          

          
          </a>

          
            
            
              <div class="version">
                tag-v1.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="terminology.html">Terminology</a></li>
<li class="toctree-l3"><a class="reference internal" href="threading_model.html">Threading model</a></li>
<li class="toctree-l3"><a class="reference internal" href="listeners.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="listener_filters.html">Listener filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="network_filters.html">Network (L3/L4) filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="http_connection_management.html">HTTP connection management</a></li>
<li class="toctree-l3"><a class="reference internal" href="http_filters.html">HTTP filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="http_routing.html">HTTP routing</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc.html">gRPC</a></li>
<li class="toctree-l3"><a class="reference internal" href="websocket.html">WebSocket support</a></li>
<li class="toctree-l3"><a class="reference internal" href="cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="service_discovery.html">Service discovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="health_checking.html">Health checking</a></li>
<li class="toctree-l3"><a class="reference internal" href="connection_pooling.html">Connection pooling</a></li>
<li class="toctree-l3"><a class="reference internal" href="load_balancing.html">Load balancing</a></li>
<li class="toctree-l3"><a class="reference internal" href="outlier.html">Outlier detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="circuit_breaking.html">Circuit breaking</a></li>
<li class="toctree-l3"><a class="reference internal" href="global_rate_limiting.html">Global rate limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="ssl.html">TLS</a></li>
<li class="toctree-l3"><a class="reference internal" href="statistics.html">Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="runtime.html">Runtime configuration</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tracing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-initiate-a-trace">How to initiate a trace</a></li>
<li class="toctree-l4"><a class="reference internal" href="#trace-context-propagation">Trace context propagation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-data-each-trace-contains">What data each trace contains</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tcp_proxy.html">TCP proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="access_logging.html">Access logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="mongo.html">MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="dynamo.html">DynamoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="redis.html">Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="hot_restart.html">Hot restart</a></li>
<li class="toctree-l3"><a class="reference internal" href="dynamic_configuration.html">Dynamic configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="init.html">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="draining.html">Draining</a></li>
<li class="toctree-l3"><a class="reference internal" href="scripting.html">Scripting</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../comparison.html">Comparison to similar systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_help.html">Getting help</a></li>
<li class="toctree-l2"><a class="reference internal" href="../version_history.html">Version history</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api-v1/api.html">v1 API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api-v2/api.html">v2 API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../intro.html">Introduction</a> &raquo;</li>
        
          <li><a href="arch_overview.html">Architecture overview</a> &raquo;</li>
        
      <li>Tracing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/intro/arch_overview/tracing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tracing">
<span id="arch-overview-tracing"></span><h1>Tracing<a class="headerlink" href="#tracing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Distributed tracing allows developers to obtain visualizations of call flows in large service
oriented architectures. It can be invaluable in understanding serialization, parallelism, and
sources of latency. Envoy supports three features related to system wide tracing:</p>
<ul class="simple">
<li><strong>Request ID generation</strong>: Envoy will generate UUIDs when needed and populate the
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> HTTP header. Applications can forward the
x-request-id header for unified logging as well as tracing.</li>
<li><strong>External trace service integration</strong>: Envoy supports pluggable external trace visualization
providers. Currently Envoy supports <a class="reference external" href="http://lightstep.com/">LightStep</a>, <a class="reference external" href="http://zipkin.io/">Zipkin</a>
or any Zipkin compatible backends (e.g. <a class="reference external" href="https://github.com/jaegertracing/">Jaeger</a>).
However, support for other tracing providers would not be difficult to add.</li>
<li><strong>Client trace ID joining</strong>: The <a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-client-trace-id"><span class="std std-ref">x-client-trace-id</span></a> header can
be used to join untrusted request IDs to the trusted internal
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a>.</li>
</ul>
</div>
<div class="section" id="how-to-initiate-a-trace">
<h2>How to initiate a trace<a class="headerlink" href="#how-to-initiate-a-trace" title="Permalink to this headline">¶</a></h2>
<p>The HTTP connection manager that handles the request must have the <a class="reference internal" href="../../api-v1/network_filters/http_conn_man.html#config-http-conn-man-tracing"><span class="std std-ref">tracing</span></a> object set. There are several ways tracing can be
initiated:</p>
<ul class="simple">
<li>By an external client via the <a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-client-trace-id"><span class="std std-ref">x-client-trace-id</span></a>
header.</li>
<li>By an internal service via the <a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-envoy-force-trace"><span class="std std-ref">x-envoy-force-trace</span></a>
header.</li>
<li>Randomly sampled via the <a class="reference internal" href="../../configuration/http_conn_man/runtime.html#config-http-conn-man-runtime-random-sampling"><span class="std std-ref">random_sampling</span></a>
runtime setting.</li>
</ul>
<p>The router filter is also capable of creating a child span for egress calls via the
<a class="reference internal" href="../../api-v1/http_filters/router_filter.html#config-http-filters-router-start-child-span"><span class="std std-ref">start_child_span</span></a> option.</p>
</div>
<div class="section" id="trace-context-propagation">
<h2>Trace context propagation<a class="headerlink" href="#trace-context-propagation" title="Permalink to this headline">¶</a></h2>
<p>Envoy provides the capability for reporting tracing information regarding communications between
services in the mesh. However, to be able to correlate the pieces of tracing information generated
by the various proxies within a call flow, the services must propagate certain trace context between
the inbound and outbound requests.</p>
<p>Whichever tracing provider is being used, the service should propagate the
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> to enable logging across the invoked services
to be correlated.</p>
<p>The tracing providers also require additional context, to enable the parent/child relationships
between the spans (logical units of work) to be understood. This can be achieved by using the
LightStep (via OpenTracing API) or Zipkin tracer directly within the service itself, to extract the
trace context from the inbound request and inject it into any subsequent outbound requests. This
approach would also enable the service to create additional spans, describing work being done
internally within the service, that may be useful when examining the end-to-end trace.</p>
<p>Alternatively the trace context can be manually propagated by the service:</p>
<ul class="simple">
<li>When using the LightStep tracer, Envoy relies on the service to propagate the
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-ot-span-context"><span class="std std-ref">x-ot-span-context</span></a> HTTP header
while sending HTTP requests to other services.</li>
<li>When using the Zipkin tracer, Envoy relies on the service to propagate the
B3 HTTP headers (
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-traceid"><span class="std std-ref">x-b3-traceid</span></a>,
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-spanid"><span class="std std-ref">x-b3-spanid</span></a>,
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-parentspanid"><span class="std std-ref">x-b3-parentspanid</span></a>,
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-sampled"><span class="std std-ref">x-b3-sampled</span></a>, and
<a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-flags"><span class="std std-ref">x-b3-flags</span></a>). The <a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-sampled"><span class="std std-ref">x-b3-sampled</span></a>
header can also be supplied by an external client to either enable or disable tracing for a particular
request.</li>
</ul>
</div>
<div class="section" id="what-data-each-trace-contains">
<h2>What data each trace contains<a class="headerlink" href="#what-data-each-trace-contains" title="Permalink to this headline">¶</a></h2>
<p>An end-to-end trace is comprised of one or more spans. A
span represents a logical unit of work that has a start time and duration and can contain metadata
associated with it. Each span generated by Envoy contains the following data:</p>
<ul class="simple">
<li>Originating service cluster set via <a class="reference internal" href="../../operations/cli.html#cmdoption-service-cluster"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-cluster</span></code></a>.</li>
<li>Start time and duration of the request.</li>
<li>Originating host set via <a class="reference internal" href="../../operations/cli.html#cmdoption-service-node"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-node</span></code></a>.</li>
<li>Downstream cluster set via the <a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-downstream-service-cluster"><span class="std std-ref">x-envoy-downstream-service-cluster</span></a>
header.</li>
<li>HTTP URL.</li>
<li>HTTP method.</li>
<li>HTTP response code.</li>
<li>Tracing system-specific metadata.</li>
</ul>
<p>The span also includes a name (or operation) which by default is defined as the host of the invoked
service. However this can be customized using a <a class="reference internal" href="../../api-v1/route_config/route.html#config-http-conn-man-route-table-decorator"><span class="std std-ref">Decorator</span></a> on
the route. The name can also be overridden using the
<a class="reference internal" href="../../configuration/http_filters/router_filter.html#config-http-filters-router-x-envoy-decorator-operation"><span class="std std-ref">x-envoy-decorator-operation</span></a> header.</p>
<p>Envoy automatically sends spans to tracing collectors. Depending on the tracing collector,
multiple spans are stitched together using common information such as the globally unique
request ID <a class="reference internal" href="../../configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> (LightStep) or
the trace ID configuration (Zipkin). See</p>
<ul class="simple">
<li><a class="reference internal" href="../../api-v1/tracing.html#config-tracing-v1"><span class="std std-ref">v1 API reference</span></a></li>
<li><a class="reference internal" href="../../api-v2/config/trace/v2/trace.proto.html#envoy-api-msg-config-trace-v2-tracing"><span class="std std-ref">v2 API reference</span></a></li>
</ul>
<p>for more information on how to setup tracing in Envoy.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tcp_proxy.html" class="btn btn-neutral float-right" title="TCP proxy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="runtime.html" class="btn btn-neutral" title="Runtime configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Envoy Project Authors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'tag-v1.7.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>