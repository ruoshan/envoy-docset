

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Supported load balancers &mdash; envoy tag-v1.9.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Original destination" href="original_dst.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> envoy
          

          
          </a>

          
            
            
              <div class="version">
                tag-v1.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../terminology.html">Terminology</a></li>
<li class="toctree-l3"><a class="reference internal" href="../threading_model.html">Threading model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listener_filters.html">Listener filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../network_filters.html">Network (L3/L4) filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_connection_management.html">HTTP connection management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_filters.html">HTTP filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_sharing_between_filters.html">Static State</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_sharing_between_filters.html#dynamic-state">Dynamic State</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_routing.html">HTTP routing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../grpc.html">gRPC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../websocket.html">WebSocket and HTTP upgrades</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="../service_discovery.html">Service discovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="../health_checking.html">Health checking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connection_pooling.html">Connection pooling</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="load_balancing.html">Load Balancing</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Supported load balancers</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_dst.html">Original destination</a></li>
<li class="toctree-l4"><a class="reference internal" href="overprovisioning.html">Overprovisioning Factor</a></li>
<li class="toctree-l4"><a class="reference internal" href="priority.html">Priority levels</a></li>
<li class="toctree-l4"><a class="reference internal" href="zone_aware.html">Zone aware routing</a></li>
<li class="toctree-l4"><a class="reference internal" href="panic_threshold.html">Panic threshold</a></li>
<li class="toctree-l4"><a class="reference internal" href="locality_weight.html">Locality weighted load balancing</a></li>
<li class="toctree-l4"><a class="reference internal" href="subsets.html">Load Balancer Subsets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../outlier.html">Outlier detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../circuit_breaking.html">Circuit breaking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../global_rate_limiting.html">Global rate limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssl.html">TLS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statistics.html">Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runtime.html">Runtime configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tracing.html">Tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tcp_proxy.html">TCP proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../access_logging.html">Access logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mongo.html">MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamo.html">DynamoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../redis.html">Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hot_restart.html">Hot restart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamic_configuration.html">Dynamic configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../init.html">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../draining.html">Draining</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scripting.html">Scripting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overload_manager.html">Overload manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../comparison.html">Comparison to similar systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">Getting help</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../version_history.html">Version history</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-v2/api.html">v2 API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../intro.html">Introduction</a> &raquo;</li>
        
          <li><a href="../arch_overview.html">Architecture overview</a> &raquo;</li>
        
          <li><a href="load_balancing.html">Load Balancing</a> &raquo;</li>
        
      <li>Supported load balancers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/intro/arch_overview/load_balancing/load_balancers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="supported-load-balancers">
<span id="arch-overview-load-balancing-types"></span><h1>Supported load balancers<a class="headerlink" href="#supported-load-balancers" title="Permalink to this headline">¶</a></h1>
<p>When a filter needs to acquire a connection to a host in an upstream cluster, the cluster manager
uses a load balancing policy to determine which host is selected. The load balancing policies are
pluggable and are specified on a per upstream cluster basis in the <a class="reference internal" href="../../../api-v2/api/v2/cds.proto.html#envoy-api-msg-cluster"><span class="std std-ref">configuration</span></a>. Note that if no active health checking policy is <a class="reference internal" href="../../../configuration/cluster_manager/cluster_hc.html#config-cluster-manager-cluster-hc"><span class="std std-ref">configured</span></a> for a cluster, all upstream cluster members are considered
healthy.</p>
<div class="section" id="weighted-round-robin">
<span id="arch-overview-load-balancing-types-round-robin"></span><h2>Weighted round robin<a class="headerlink" href="#weighted-round-robin" title="Permalink to this headline">¶</a></h2>
<p>This is a simple policy in which each healthy upstream host is selected in round
robin order. If <a class="reference internal" href="../../../api-v2/api/v2/endpoint/endpoint.proto.html#envoy-api-field-endpoint-lbendpoint-load-balancing-weight"><span class="std std-ref">weights</span></a> are assigned to
endpoints in a locality, then a weighted round robin schedule is used, where
higher weighted endpoints will appear more often in the rotation to achieve the
effective weighting.</p>
</div>
<div class="section" id="weighted-least-request">
<span id="arch-overview-load-balancing-types-least-request"></span><h2>Weighted least request<a class="headerlink" href="#weighted-least-request" title="Permalink to this headline">¶</a></h2>
<p>The least request load balancer uses different algorithms depending on whether any of the hosts have
weight greater than 1.</p>
<ul>
<li><p class="first"><em>all weights 1</em>: An O(1) algorithm which selects N random healthy hosts as specified in the
<a class="reference internal" href="../../../api-v2/api/v2/cds.proto.html#envoy-api-msg-cluster-leastrequestlbconfig"><span class="std std-ref">configuration</span></a> (2 by default) and picks the
host which has the fewest active requests (<a class="reference external" href="http://www.eecs.harvard.edu/~michaelm/postscripts/handbook2001.pdf">Research</a> has shown that this
approach is nearly as good as an O(N) full scan). This is also known as P2C (power of two
choices). The P2C load balancer has the property that a host with the highest number of active
requests in the cluster will never receive new requests. It will be allowed to drain until it is
less than or equal to all of the other hosts.</p>
</li>
<li><p class="first"><em>not all weights 1</em>:  If any host in the cluster has a load balancing weight greater than 1, the
load balancer shifts into a mode where it uses a weighted round robin schedule in which weights
are dynamically adjusted based on the host’s request load at the time of selection (weight is
divided by the current active request count. For example, a host with weight 2 and an active
request count of 4 will have a synthetic weight of 2 / 4 = 0.5). This algorithm provides good
balance at steady state but may not adapt to load imbalance as quickly. Additionally, unlike P2C,
a host will never truly drain, though it will receive fewer requests over time.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If all weights are not 1, but are the same (e.g., 42), Envoy will still use the weighted round
robin schedule instead of P2C.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="ring-hash">
<span id="arch-overview-load-balancing-types-ring-hash"></span><h2>Ring hash<a class="headerlink" href="#ring-hash" title="Permalink to this headline">¶</a></h2>
<p>The ring/modulo hash load balancer implements consistent hashing to upstream hosts. The algorithm is
based on mapping all hosts onto a circle such that the addition or removal of a host from the host
set changes only affect 1/N requests. This technique is also commonly known as <a class="reference external" href="https://github.com/RJ/ketama">“ketama”</a> hashing. A consistent hashing load balancer is only effective
when protocol routing is used that specifies a value to hash on. The minimum ring size governs the
replication factor for each host in the ring. For example, if the minimum ring size is 1024 and
there are 16 hosts, each host will be replicated 64 times. The ring hash load balancer does not
currently support weighting.</p>
<p>When priority based load balancing is in use, the priority level is also chosen by hash, so the
endpoint selected will still be consistent when the set of backends is stable.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The ring hash load balancer does not support <a class="reference internal" href="locality_weight.html#arch-overview-load-balancing-locality-weighted-lb"><span class="std std-ref">locality weighted load
balancing</span></a>.</p>
</div>
</div>
<div class="section" id="maglev">
<span id="arch-overview-load-balancing-types-maglev"></span><h2>Maglev<a class="headerlink" href="#maglev" title="Permalink to this headline">¶</a></h2>
<p>The Maglev load balancer implements consistent hashing to upstream hosts. It uses the algorithm
described in section 3.4 of <a class="reference external" href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/44824.pdf">this paper</a>
with a fixed table size of 65537 (see section 5.3 of the same paper). Maglev can be used as a drop
in replacement for the <a class="reference internal" href="#arch-overview-load-balancing-types-ring-hash"><span class="std std-ref">ring hash load balancer</span></a>
any place in which consistent hashing is desired. Like the ring hash load balancer, a consistent
hashing load balancer is only effective when protocol routing is used that specifies a value to
hash on.</p>
<p>In general, when compared to the ring hash (“ketama”) algorithm, Maglev has substantially faster
table lookup build times as well as host selection times (approximately 10x and 5x respectively
when using a large ring size of 256K entries). The downside of Maglev is that it is not as stable
as ring hash. More keys will move position when hosts are removed (simulations show approximately
double the keys will move). With that said, for many applications including Redis, Maglev is very
likely a superior drop in replacement for ring hash. The advanced reader can use
<a class="reference external" href="https://github.com/envoyproxy/envoy/blob/master//test/common/upstream/load_balancer_benchmark.cc">this benchmark</a> to compare ring hash
versus Maglev with different parameters.</p>
</div>
<div class="section" id="random">
<span id="arch-overview-load-balancing-types-random"></span><h2>Random<a class="headerlink" href="#random" title="Permalink to this headline">¶</a></h2>
<p>The random load balancer selects a random healthy host. The random load balancer generally performs
better than round robin if no health checking policy is configured. Random selection avoids bias
towards the host in the set that comes after a failed host.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="original_dst.html" class="btn btn-neutral float-right" title="Original destination" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="overview.html" class="btn btn-neutral" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>