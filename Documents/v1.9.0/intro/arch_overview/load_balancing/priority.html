

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Priority levels &mdash; envoy tag-v1.9.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Zone aware routing" href="zone_aware.html" />
    <link rel="prev" title="Overprovisioning Factor" href="overprovisioning.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> envoy
          

          
          </a>

          
            
            
              <div class="version">
                tag-v1.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../terminology.html">Terminology</a></li>
<li class="toctree-l3"><a class="reference internal" href="../threading_model.html">Threading model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listener_filters.html">Listener filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../network_filters.html">Network (L3/L4) filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_connection_management.html">HTTP connection management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_filters.html">HTTP filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_sharing_between_filters.html">Static State</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_sharing_between_filters.html#dynamic-state">Dynamic State</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_routing.html">HTTP routing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../grpc.html">gRPC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../websocket.html">WebSocket and HTTP upgrades</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="../service_discovery.html">Service discovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="../health_checking.html">Health checking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connection_pooling.html">Connection pooling</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="load_balancing.html">Load Balancing</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="load_balancers.html">Supported load balancers</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_dst.html">Original destination</a></li>
<li class="toctree-l4"><a class="reference internal" href="overprovisioning.html">Overprovisioning Factor</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Priority levels</a></li>
<li class="toctree-l4"><a class="reference internal" href="zone_aware.html">Zone aware routing</a></li>
<li class="toctree-l4"><a class="reference internal" href="panic_threshold.html">Panic threshold</a></li>
<li class="toctree-l4"><a class="reference internal" href="locality_weight.html">Locality weighted load balancing</a></li>
<li class="toctree-l4"><a class="reference internal" href="subsets.html">Load Balancer Subsets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../outlier.html">Outlier detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../circuit_breaking.html">Circuit breaking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../global_rate_limiting.html">Global rate limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssl.html">TLS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statistics.html">Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runtime.html">Runtime configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tracing.html">Tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tcp_proxy.html">TCP proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../access_logging.html">Access logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mongo.html">MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamo.html">DynamoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../redis.html">Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hot_restart.html">Hot restart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamic_configuration.html">Dynamic configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../init.html">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../draining.html">Draining</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scripting.html">Scripting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overload_manager.html">Overload manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../comparison.html">Comparison to similar systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">Getting help</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../version_history.html">Version history</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-v2/api.html">v2 API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../intro.html">Introduction</a> &raquo;</li>
        
          <li><a href="../arch_overview.html">Architecture overview</a> &raquo;</li>
        
          <li><a href="load_balancing.html">Load Balancing</a> &raquo;</li>
        
      <li>Priority levels</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/intro/arch_overview/load_balancing/priority.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="priority-levels">
<span id="arch-overview-load-balancing-priority-levels"></span><h1>Priority levels<a class="headerlink" href="#priority-levels" title="Permalink to this headline">¶</a></h1>
<p>During load balancing, Envoy will generally only consider hosts configured at the highest priority
level. For each EDS <a class="reference internal" href="../../../api-v2/api/v2/endpoint/endpoint.proto.html#envoy-api-msg-endpoint-localitylbendpoints"><span class="std std-ref">LocalityLbEndpoints</span></a> an optional
priority may also be specified. When endpoints at the highest priority level (P=0) are healthy, all
traffic will land on endpoints in that priority level. As endpoints for the highest priority level
become unhealthy, traffic will begin to trickle to lower priority levels.</p>
<p>The system can be overprovisioned with a configurable
<a class="reference internal" href="overprovisioning.html#arch-overview-load-balancing-overprovisioning-factor"><span class="std std-ref">overprovisioning factor</span></a>, which
currently defaults to 1.4 (this document will assume this value). If 80% of the endpoints in a
priority level are healthy, that level is still considered fully healthy because 80*1.4 &gt; 100.
So, level 0 endpoints will continue to receive all traffic until less than ~71.4% of them are
healthy.</p>
<p>The priority level logic works with integer health scores. The health score of a level is
(percent of healthy hosts in the level) * (overprovisioning factor), capped at 100%. P=0
endpoints receive (level 0’s health score) percent of the traffic, with the rest flowing
to P=1 (assuming P=1 is 100% healthy - more on that later). For instance, when 50% of P=0
endpoints are healthy, they will receive 50 * 1.4 = 70% of the traffic.
The integer percents of traffic that each priority level receives are collectively called the
system’s “priority load”. More examples (with 2 priority levels, P=1 100% healthy):</p>
<table border="1" class="docutils">
<colgroup>
<col width="46%" />
<col width="26%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">P=0 healthy endpoints</th>
<th class="head">Traffic to P=0</th>
<th class="head">Traffic to P=1</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>100%</td>
<td>100%</td>
<td>0%</td>
</tr>
<tr class="row-odd"><td>72%</td>
<td>100%</td>
<td>0%</td>
</tr>
<tr class="row-even"><td>71%</td>
<td>99%</td>
<td>1%</td>
</tr>
<tr class="row-odd"><td>50%</td>
<td>70%</td>
<td>30%</td>
</tr>
<tr class="row-even"><td>25%</td>
<td>35%</td>
<td>65%</td>
</tr>
<tr class="row-odd"><td>0%</td>
<td>0%</td>
<td>100%</td>
</tr>
</tbody>
</table>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">In order for the load distribution algorithm and normalized total health calculation to work
properly, each priority level must be able to handle (100% * overprovision factor) of the
traffic: Envoy assumes a 100% healthy P=1 can take over entirely for an unhealthy P=0, etc.
If P=0 has 10 hosts but P=1 only has 2 hosts, that assumption probably will not hold.</p>
</div>
<p>The health score represents a level’s current ability to handle traffic, after factoring in how
overprovisioned the level originally was, and how many endpoints are currently unhealthy.
Therefore, if the sum across all levels’ health scores is &lt; 100, then Envoy believes there are not
enough healthy endpoints to fully handle the traffic. This sum is called the “normalized total
health.” When normalized total health drops below 100, traffic is distributed after normalizing
the levels’ health scores to that sub-100 total. E.g. healths of {20, 30} (yielding a normalized
total health of 50) would be normalized, and result in a priority load of {40%, 60%} of traffic.</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="30%" />
<col width="21%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">P=0 healthy endpoints</th>
<th class="head">P=1 healthy endpoints</th>
<th class="head">Traffic to  P=0</th>
<th class="head">Traffic to P=1</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>100%</td>
<td>100%</td>
<td>100%</td>
<td>0%</td>
</tr>
<tr class="row-odd"><td>72%</td>
<td>72%</td>
<td>100%</td>
<td>0%</td>
</tr>
<tr class="row-even"><td>71%</td>
<td>71%</td>
<td>99%</td>
<td>1%</td>
</tr>
<tr class="row-odd"><td>50%</td>
<td>50%</td>
<td>70%</td>
<td>30%</td>
</tr>
<tr class="row-even"><td>25%</td>
<td>100%</td>
<td>35%</td>
<td>65%</td>
</tr>
<tr class="row-odd"><td>25%</td>
<td>25%</td>
<td>50%</td>
<td>50%</td>
</tr>
</tbody>
</table>
<p>As more priorities are added, each level consumes load equal to its normalized effective health,
unless the healths of the levels above it sum to 100%, in which case it receives no load.</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">P=0 healthy endpoints</th>
<th class="head">P=1 healthy endpoints</th>
<th class="head">P=2 healthy endpoints</th>
<th class="head">Traffic to P=0</th>
<th class="head">Traffic to P=1</th>
<th class="head">Traffic to P=2</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>100%</td>
<td>100%</td>
<td>100%</td>
<td>100%</td>
<td>0%</td>
<td>0%</td>
</tr>
<tr class="row-odd"><td>72%</td>
<td>72%</td>
<td>100%</td>
<td>100%</td>
<td>0%</td>
<td>0%</td>
</tr>
<tr class="row-even"><td>71%</td>
<td>71%</td>
<td>100%</td>
<td>99%</td>
<td>1%</td>
<td>0%</td>
</tr>
<tr class="row-odd"><td>50%</td>
<td>50%</td>
<td>100%</td>
<td>70%</td>
<td>30%</td>
<td>0%</td>
</tr>
<tr class="row-even"><td>25%</td>
<td>100%</td>
<td>100%</td>
<td>35%</td>
<td>65%</td>
<td>0%</td>
</tr>
<tr class="row-odd"><td>25%</td>
<td>25%</td>
<td>100%</td>
<td>35%</td>
<td>35%</td>
<td>30%</td>
</tr>
<tr class="row-even"><td>25%</td>
<td>25%</td>
<td>20%</td>
<td>36%</td>
<td>36%</td>
<td>28%</td>
</tr>
</tbody>
</table>
<p>To sum this up in pseudo algorithms:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mf">1.4</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">healthy_P_X_backends</span> <span class="o">/</span> <span class="n">total_P_X_backends</span><span class="p">)</span>
<span class="n">normalized_total_health</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">Σ</span><span class="p">(</span><span class="n">health</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span><span class="o">...</span><span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">)))</span>
<span class="n">priority_load</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">health</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span> <span class="o">/</span> <span class="n">normalized_total_health</span><span class="p">)</span>
<span class="n">priority_load</span><span class="p">(</span><span class="n">P_X</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">Σ</span><span class="p">(</span><span class="n">priority_load</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span><span class="o">..</span><span class="n">priority_load</span><span class="p">(</span><span class="n">P_X</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                         <span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">)</span> <span class="o">/</span> <span class="n">normalized_total_health</span><span class="p">)</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="zone_aware.html" class="btn btn-neutral float-right" title="Zone aware routing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="overprovisioning.html" class="btn btn-neutral" title="Overprovisioning Factor" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>