

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Zone aware routing &mdash; envoy tag-v1.9.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Panic threshold" href="panic_threshold.html" />
    <link rel="prev" title="Priority levels" href="priority.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> envoy
          

          
          </a>

          
            
            
              <div class="version">
                tag-v1.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../terminology.html">Terminology</a></li>
<li class="toctree-l3"><a class="reference internal" href="../threading_model.html">Threading model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listener_filters.html">Listener filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../network_filters.html">Network (L3/L4) filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_connection_management.html">HTTP connection management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_filters.html">HTTP filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_sharing_between_filters.html">Static State</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_sharing_between_filters.html#dynamic-state">Dynamic State</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http_routing.html">HTTP routing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../grpc.html">gRPC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../websocket.html">WebSocket and HTTP upgrades</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="../service_discovery.html">Service discovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="../health_checking.html">Health checking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connection_pooling.html">Connection pooling</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="load_balancing.html">Load Balancing</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="load_balancers.html">Supported load balancers</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_dst.html">Original destination</a></li>
<li class="toctree-l4"><a class="reference internal" href="overprovisioning.html">Overprovisioning Factor</a></li>
<li class="toctree-l4"><a class="reference internal" href="priority.html">Priority levels</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Zone aware routing</a></li>
<li class="toctree-l4"><a class="reference internal" href="panic_threshold.html">Panic threshold</a></li>
<li class="toctree-l4"><a class="reference internal" href="locality_weight.html">Locality weighted load balancing</a></li>
<li class="toctree-l4"><a class="reference internal" href="subsets.html">Load Balancer Subsets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../outlier.html">Outlier detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../circuit_breaking.html">Circuit breaking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../global_rate_limiting.html">Global rate limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssl.html">TLS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statistics.html">Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runtime.html">Runtime configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tracing.html">Tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tcp_proxy.html">TCP proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../access_logging.html">Access logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mongo.html">MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamo.html">DynamoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../redis.html">Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hot_restart.html">Hot restart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamic_configuration.html">Dynamic configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../init.html">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../draining.html">Draining</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scripting.html">Scripting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overload_manager.html">Overload manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../comparison.html">Comparison to similar systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">Getting help</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../version_history.html">Version history</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-v2/api.html">v2 API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../intro.html">Introduction</a> &raquo;</li>
        
          <li><a href="../arch_overview.html">Architecture overview</a> &raquo;</li>
        
          <li><a href="load_balancing.html">Load Balancing</a> &raquo;</li>
        
      <li>Zone aware routing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/intro/arch_overview/load_balancing/zone_aware.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="zone-aware-routing">
<span id="arch-overview-load-balancing-zone-aware-routing"></span><h1>Zone aware routing<a class="headerlink" href="#zone-aware-routing" title="Permalink to this headline">¶</a></h1>
<p>We use the following terminology:</p>
<ul class="simple">
<li><strong>Originating/Upstream cluster</strong>: Envoy routes requests from an originating cluster to an upstream
cluster.</li>
<li><strong>Local zone</strong>: The same zone that contains a subset of hosts in both the originating and
upstream clusters.</li>
<li><strong>Zone aware routing</strong>: Best effort routing of requests to an upstream cluster host in the local
zone.</li>
</ul>
<p>In deployments where hosts in originating and upstream clusters belong to different zones
Envoy performs zone aware routing. There are several preconditions before zone aware routing can be
performed:</p>
<ul class="simple" id="arch-overview-load-balancing-zone-aware-routing-preconditions">
<li>Both originating and upstream cluster are not in
<a class="reference internal" href="panic_threshold.html#arch-overview-load-balancing-panic-threshold"><span class="std std-ref">panic mode</span></a>.</li>
<li>Zone aware <a class="reference internal" href="../../../configuration/cluster_manager/cluster_runtime.html#config-cluster-manager-cluster-runtime-zone-routing"><span class="std std-ref">routing is enabled</span></a>.</li>
<li>The originating cluster has the same number of zones as the upstream cluster.</li>
<li>The upstream cluster has enough hosts. See
<a class="reference internal" href="../../../configuration/cluster_manager/cluster_runtime.html#config-cluster-manager-cluster-runtime-zone-routing"><span class="std std-ref">here</span></a> for more information.</li>
</ul>
<p>The purpose of zone aware routing is to send as much traffic to the local zone in the upstream
cluster as possible while roughly maintaining the same number of requests per second across all
upstream hosts (depending on load balancing policy).</p>
<p>Envoy tries to push as much traffic as possible to the local upstream zone as long as
roughly the same number of requests per host in the upstream cluster are maintained. The decision of
whether Envoy routes to the local zone or performs cross zone routing depends on the percentage of
healthy hosts in the originating cluster and upstream cluster in the local zone. There are two cases
with regard to percentage relations in the local zone between originating and upstream clusters:</p>
<ul class="simple">
<li>The originating cluster local zone percentage is greater than the one in the upstream cluster.
In this case we cannot route all requests from the local zone of the originating cluster to the
local zone of the upstream cluster because that will lead to request imbalance across all upstream
hosts. Instead, Envoy calculates the percentage of requests that can be routed directly to the
local zone of the upstream cluster. The rest of the requests are routed cross zone. The specific
zone is selected based on the residual capacity of the zone (that zone will get some local zone
traffic and may have additional capacity Envoy can use for cross zone traffic).</li>
<li>The originating cluster local zone percentage is smaller than the one in upstream cluster.
In this case the local zone of the upstream cluster can get all of the requests from the
local zone of the originating cluster and also have some space to allow traffic from other zones
in the originating cluster (if needed).</li>
</ul>
<p>Note that when using multiple priorities, zone aware routing is currently only supported for P=0.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="panic_threshold.html" class="btn btn-neutral float-right" title="Panic threshold" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="priority.html" class="btn btn-neutral" title="Priority levels" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>